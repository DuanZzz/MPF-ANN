\documentclass[]{article}
\usepackage{xeCJK}
\setCJKmainfont{Noto Sans CJK HK}
\usepackage{lmodern}
\usepackage{amssymb,amsmath}
\usepackage{ifxetex,ifluatex}
\usepackage{fixltx2e} % provides \textsubscript
\ifnum 0\ifxetex 1\fi\ifluatex 1\fi=0 % if pdftex
  \usepackage[T1]{fontenc}
  \usepackage[utf8]{inputenc}
\else % if luatex or xelatex
  \ifxetex
    \usepackage{mathspec}
  \else
    \usepackage{fontspec}
  \fi
  \defaultfontfeatures{Ligatures=TeX,Scale=MatchLowercase}
\fi
\setmainfont{Noto Sans CJK HK}
\setmonofont{Noto Mono}
% use upquote if available, for straight quotes in verbatim environments
\IfFileExists{upquote.sty}{\usepackage{upquote}}{}
% use microtype if available
\IfFileExists{microtype.sty}{%
\usepackage{microtype}
\UseMicrotypeSet[protrusion]{basicmath} % disable protrusion for tt fonts
}{}
\usepackage[margin=1in]{geometry}
\usepackage{hyperref}
\hypersetup{unicode=true,
            pdftitle={銀聯強積金應用人工神經網絡的早期試驗 - BCT MPF-ANN Backtesting (Preliminary Trial)},
            pdfborder={0 0 0},
            breaklinks=true}
\urlstyle{same}  % don't use monospace font for urls
\usepackage{color}
\usepackage{fancyvrb}
\newcommand{\VerbBar}{|}
\newcommand{\VERB}{\Verb[commandchars=\\\{\}]}
\DefineVerbatimEnvironment{Highlighting}{Verbatim}{commandchars=\\\{\}}
% Add ',fontsize=\small' for more characters per line
\usepackage{framed}
\definecolor{shadecolor}{RGB}{248,248,248}
\newenvironment{Shaded}{\begin{snugshade}}{\end{snugshade}}
\newcommand{\AlertTok}[1]{\textcolor[rgb]{0.94,0.16,0.16}{#1}}
\newcommand{\AnnotationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\AttributeTok}[1]{\textcolor[rgb]{0.77,0.63,0.00}{#1}}
\newcommand{\BaseNTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\BuiltInTok}[1]{#1}
\newcommand{\CharTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\CommentTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textit{#1}}}
\newcommand{\CommentVarTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\ConstantTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\ControlFlowTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{\textbf{#1}}}
\newcommand{\DataTypeTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{#1}}
\newcommand{\DecValTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\DocumentationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\ErrorTok}[1]{\textcolor[rgb]{0.64,0.00,0.00}{\textbf{#1}}}
\newcommand{\ExtensionTok}[1]{#1}
\newcommand{\FloatTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\FunctionTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\ImportTok}[1]{#1}
\newcommand{\InformationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\KeywordTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{\textbf{#1}}}
\newcommand{\NormalTok}[1]{#1}
\newcommand{\OperatorTok}[1]{\textcolor[rgb]{0.81,0.36,0.00}{\textbf{#1}}}
\newcommand{\OtherTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{#1}}
\newcommand{\PreprocessorTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textit{#1}}}
\newcommand{\RegionMarkerTok}[1]{#1}
\newcommand{\SpecialCharTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\SpecialStringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\StringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\VariableTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\VerbatimStringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\WarningTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\usepackage{longtable,booktabs}
\usepackage{graphicx,grffile}
\makeatletter
\def\maxwidth{\ifdim\Gin@nat@width>\linewidth\linewidth\else\Gin@nat@width\fi}
\def\maxheight{\ifdim\Gin@nat@height>\textheight\textheight\else\Gin@nat@height\fi}
\makeatother
% Scale images if necessary, so that they will not overflow the page
% margins by default, and it is still possible to overwrite the defaults
% using explicit options in \includegraphics[width, height, ...]{}
\setkeys{Gin}{width=\maxwidth,height=\maxheight,keepaspectratio}
\IfFileExists{parskip.sty}{%
\usepackage{parskip}
}{% else
\setlength{\parindent}{0pt}
\setlength{\parskip}{6pt plus 2pt minus 1pt}
}
\setlength{\emergencystretch}{3em}  % prevent overfull lines
\providecommand{\tightlist}{%
  \setlength{\itemsep}{0pt}\setlength{\parskip}{0pt}}
\setcounter{secnumdepth}{0}
% Redefines (sub)paragraphs to behave more like sections
\ifx\paragraph\undefined\else
\let\oldparagraph\paragraph
\renewcommand{\paragraph}[1]{\oldparagraph{#1}\mbox{}}
\fi
\ifx\subparagraph\undefined\else
\let\oldsubparagraph\subparagraph
\renewcommand{\subparagraph}[1]{\oldsubparagraph{#1}\mbox{}}
\fi

%%% Use protect on footnotes to avoid problems with footnotes in titles
\let\rmarkdownfootnote\footnote%
\def\footnote{\protect\rmarkdownfootnote}

%%% Change title format to be more compact
\usepackage{titling}

% Create subtitle command for use in maketitle
\providecommand{\subtitle}[1]{
  \posttitle{
    \begin{center}\large#1\end{center}
    }
}

\setlength{\droptitle}{-2em}

  \title{銀聯強積金應用人工神經網絡的早期試驗 - BCT MPF-ANN Backtesting
(Preliminary Trial)}
    \pretitle{\vspace{\droptitle}\centering\huge}
  \posttitle{\par}
    \author{}
    \preauthor{}\postauthor{}
    \date{}
    \predate{}\postdate{}
  

\begin{document}
\maketitle

\hypertarget{disclamier-of-warranties}{%
\subsection{Disclamier of warranties}\label{disclamier-of-warranties}}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  The author (jchan-gi) expressly stated that nothing my repositories
  and webpages constitutes any advices or recommendation on investing or
  allocating assets on any stock or financial products.\\
\item
  No content in my study have been prepared with respect to specific
  personal need and investment objects of individuals. All materials
  reveal to the public are applicable to the author (jchan-gi) only.
\item
  All investors shall obtain kind advices from professional financial
  consultants before making any decisions. Professional financial
  consultants should recommend products or decisions that suit your
  needs and objectives.\\
\item
  The author is not licensed nor professional in the field hence this
  studies are not professional advice and may not be suitable for anyone
  except myself.
\end{enumerate}

\hypertarget{last-update-20191122.}{%
\subsubsection{Last update: 2019/11/22.}\label{last-update-20191122.}}

\hypertarget{the-algorithm-have-been-changed-significantly-on-20190815.}{%
\subsubsection{The algorithm have been changed significantly on
2019/08/15.}\label{the-algorithm-have-been-changed-significantly-on-20190815.}}

We removed the VIX condition in our algorithm.\\
Changes in condition of hedge are also expected.\\
Three major outcomes is targeted in our study:\\
1. \textasciitilde{}8-10\% annualized return\\
2. \textless{}10\% annualized standard deviation (\textasciitilde{}3\%
monthly)\\
3. \textgreater{}1 sharpe ratio

\hypertarget{monthly-installment-results-available-from-20190912.}{%
\subsubsection{Monthly installment results available from
2019/09/12.}\label{monthly-installment-results-available-from-20190912.}}

\hypertarget{due-to-extreme-volality-and-manipulated-market-the-chinese-tracker-fund-col-4-have-been-manually-excluded-from-calculation-with-effect-from-20190912.}{%
\subsubsection{Due to extreme volality and manipulated market, the
Chinese Tracker fund (col = 4) have been manually excluded from
calculation with effect from
2019/09/12.}\label{due-to-extreme-volality-and-manipulated-market-the-chinese-tracker-fund-col-4-have-been-manually-excluded-from-calculation-with-effect-from-20190912.}}

\hypertarget{the-raw-data-feed-into-the-neural-network-have-modified-into-timestep-format-on-20191122.}{%
\subsubsection{The raw data feed into the neural network have modified
into timestep format on
2019/11/22.}\label{the-raw-data-feed-into-the-neural-network-have-modified-into-timestep-format-on-20191122.}}

\hypertarget{warning-please-read-the-notification-in-this-section-first}{%
\subsection{WARNING: Please read the notification in this section
first:}\label{warning-please-read-the-notification-in-this-section-first}}

This script uses artifical neural network (ANN) model for MPF fund
allocation.\\
However, ANN is stochastic in nature. It produces different results
based on the pseudo-random seed (system time).\\
30 portfolios have been generated in order to generate trustworthy
statistics for better prediction.

In addition, the prediction have no additional validation, the portfolio
used a kind of walk-forward validation.\\
If the model is poor, then the return shall be poor.

In our script, we determined 0.0013 as the initial learning rate and
epochs of 22.

\hypertarget{introduction}{%
\subsubsection{Introduction}\label{introduction}}

Mandatory Provident Fund (MPF) is one of the legal pensions in Hong
Kong.\\
Employees and Employers are required to pay at least 5\% of monthly
salary to MPF services provider.\\
MPF providers are required to provide designated funds for employees to
invest, while the team could earn management fees.

However, the average annualized return of MPF is 3.1\% only in from
2000-2016 (Mandatory Provident Fund Schemes Authority, 2016).\\
Hence most Hongkong employees feels they are forced to give their salary
to fund manager.\\
Indeed, the reasons of low return may due to inactive management by
employees.\\
In this example, we will explore artifical neural network to rise the
annualized return.

\hypertarget{bct-mpf-portfolio-generation-using-artifical-neural-network-ann-relative-strength-index}{%
\subsubsection{BCT MPF Portfolio Generation using Artifical Neural
Network (ANN) Relative Strength
Index}\label{bct-mpf-portfolio-generation-using-artifical-neural-network-ann-relative-strength-index}}

Artifical Neural Network is a stochastic black-box model. It receives
input and output the result by passing weighted values in neurons.\\
Formal definition could be searched on internet.\\
To support our application, we will uses Relative Strength Index (RSI)
(customized period) to refine our prices.\\
RSI shows whether a stock/fund overbuy (or oversell) hence overpriced
(or underpriced).

In our example, we directly uses Long-Short Term Memory to train and
predict the future price of MPF constitute fund prices.\\
The fund would be finalized by applying penalty based on the result of
RSI and VIX.

\hypertarget{when-to-manage}{%
\subsubsection{When to manage?}\label{when-to-manage}}

In this example, we are going to collect daily price for all MPF fund in
last day of a month.\\
Then, we are going to convert or reallocate the assets at the same
time.\\
Notice that it is impossible since MPF price are uploaded 1 business
day, also reallocation need at lest 2 business day to achieve.

\hypertarget{results}{%
\subsubsection{Results}\label{results}}

Using Top 2 Performers in LSTM ANN (Lastest rebalance date: 2019/07/31)

Annualized Return: \textasciitilde{}11.88\%\\
Mean Annual Return: \textasciitilde{}11.47\%\\
Annualized Standard Deviation: \textasciitilde{}9.49\% (StdDev(monthly
return) * sqrt(12))\\
Sharpe Ratio (Mean Annual Return): 11.47\%/9.49\% = 1.2091\\
Sortino Ratio: 0.8054 (MAR = 0\%)\\
Expected Shortfall: 4.46\% loss (0\% Risk-free rate, 95\% C.I.)\\
Deflated Sharpe Ratio (p-value): \textgreater{}99.9999\% (rounded to 1)

Monthly installment:\\
Total contribution: 337500\\
Latest asset value: 1048491\\
Mean annual return: 10.14\%\\
Internal Rate of Return (IRR): 10.41\%\\
Annualized Standard Deviation: 9.46\%\\
Sharpe Ratio: 1.0722\\
Sortino Ratio: 0.7324 (MAR = 0\%)\\
Expected Shortfall: 4.53\% loss (0\% Risk-free rate, 95\% C.I.)

\hypertarget{recommended-parameters}{%
\subsection{Recommended Parameters}\label{recommended-parameters}}

\begin{longtable}[]{@{}lll@{}}
\toprule
Variable & Val. & Explanation\tabularnewline
\midrule
\endhead
top & 2 & Top n Performer\tabularnewline
RSI\_Overbuy & 0.85 & RSI indicator (\%)\tabularnewline
RSI\_Period & 18 & MA period for RSI (months)\tabularnewline
Min\_NMMA & 0.001 & Minimum Monthly Return to be consider\tabularnewline
\bottomrule
\end{longtable}

\hypertarget{detailed-workflow}{%
\subsection{Detailed Workflow}\label{detailed-workflow}}

\hypertarget{package-preparation}{%
\subsubsection{Package Preparation}\label{package-preparation}}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Install necessary packages
\end{enumerate}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{r =}\StringTok{ }\KeywordTok{getOption}\NormalTok{(}\StringTok{"repos"}\NormalTok{)}
\NormalTok{r[}\StringTok{"CRAN"}\NormalTok{] =}\StringTok{ "https://mran.revolutionanalytics.com/snapshot/2019-10-01"}
\KeywordTok{options}\NormalTok{(}\DataTypeTok{repos =}\NormalTok{ r)}
\KeywordTok{install.packages}\NormalTok{(}\StringTok{"zoo"}\NormalTok{)}
\KeywordTok{install.packages}\NormalTok{(}\StringTok{"xts"}\NormalTok{)}
\KeywordTok{install.packages}\NormalTok{(}\StringTok{"fBasics"}\NormalTok{)}
\KeywordTok{install.packages}\NormalTok{(}\StringTok{"quantmod"}\NormalTok{)}
\KeywordTok{install.packages}\NormalTok{(}\StringTok{"PerformanceAnalytics"}\NormalTok{)}
\KeywordTok{install.packages}\NormalTok{(}\StringTok{"keras"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{1}
\tightlist
\item
  Now load necessary packages.
\end{enumerate}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{library}\NormalTok{(}\StringTok{"zoo"}\NormalTok{)}
\KeywordTok{library}\NormalTok{(}\StringTok{"xts"}\NormalTok{)}
\KeywordTok{library}\NormalTok{(}\StringTok{"fBasics"}\NormalTok{)}
\KeywordTok{library}\NormalTok{(}\StringTok{"quantmod"}\NormalTok{)}
\KeywordTok{library}\NormalTok{(}\StringTok{"PerformanceAnalytics"}\NormalTok{)}
\KeywordTok{library}\NormalTok{(}\StringTok{"keras"}\NormalTok{)}
\KeywordTok{library}\NormalTok{(}\StringTok{"tensorflow"}\NormalTok{)}


\KeywordTok{require}\NormalTok{(}\StringTok{"knitr"}\NormalTok{)}
\NormalTok{opts_chunk}\OperatorTok{$}\KeywordTok{set}\NormalTok{(}\DataTypeTok{tidy.opts=}\KeywordTok{list}\NormalTok{(}\DataTypeTok{width.cutoff=}\DecValTok{80}\NormalTok{),}\DataTypeTok{tidy=}\OtherTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{load-prices-and-calculate-return}{%
\subsubsection{Load Prices and Calculate
Return}\label{load-prices-and-calculate-return}}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{-1}
\tightlist
\item
  Parameters
\end{enumerate}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{top <-}\StringTok{ }\DecValTok{2}
\NormalTok{RSI_Overbuy <-}\StringTok{ }\FloatTok{0.85}
\NormalTok{RSI_Period <-}\StringTok{ }\DecValTok{18} 
\NormalTok{Min_NMMA <-}\StringTok{ }\FloatTok{1e-6}
\end{Highlighting}
\end{Shaded}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Load the price into zoo format
\end{enumerate}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{setwd}\NormalTok{(}\StringTok{"~"}\NormalTok{)}
\NormalTok{MPF.BCT <-}
\StringTok{  }\KeywordTok{as.xts}\NormalTok{(}
    \KeywordTok{read.zoo}\NormalTok{(}
      \StringTok{"MPF/BCT/BCT.csv"}\NormalTok{,}
      \DataTypeTok{format =} \StringTok{"%Y/%m/%d"}\NormalTok{,}
      \DataTypeTok{header =} \OtherTok{TRUE}\NormalTok{,}
      \DataTypeTok{read =}\NormalTok{ read.csv,}
      \DataTypeTok{na.strings =} \StringTok{"0"}
\NormalTok{    )}
\NormalTok{  )}
\NormalTok{daily <-}\StringTok{ }\KeywordTok{index}\NormalTok{(MPF.BCT)}
\NormalTok{monthly.old <-}\StringTok{ }\KeywordTok{index}\NormalTok{(MPF.BCT.returns)}
\NormalTok{MPF.BCT.w.all.backup <-}\StringTok{ }\NormalTok{MPF.BCT.w.all}
\end{Highlighting}
\end{Shaded}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{1}
\item
  Calculate Relative Strength Index (RSI)
\item
  Calculate Returns
\end{enumerate}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{MPF.BCT.AE <-}\StringTok{ }\KeywordTok{monthlyReturn}\NormalTok{(}\KeywordTok{as.xts}\NormalTok{(MPF.BCT}\OperatorTok{$}\NormalTok{AE), }\DataTypeTok{type =} \StringTok{"log"}\NormalTok{)}
\NormalTok{MPF.BCT.CA <-}\StringTok{ }\KeywordTok{monthlyReturn}\NormalTok{(}\KeywordTok{as.xts}\NormalTok{(MPF.BCT}\OperatorTok{$}\NormalTok{CA), }\DataTypeTok{type =} \StringTok{"log"}\NormalTok{)}
\NormalTok{MPF.BCT.CEHK <-}\StringTok{ }\KeywordTok{monthlyReturn}\NormalTok{(}\KeywordTok{as.xts}\NormalTok{(MPF.BCT}\OperatorTok{$}\NormalTok{CEHK), }\DataTypeTok{type =} \StringTok{"log"}\NormalTok{)}
\NormalTok{MPF.BCT.CT <-}\StringTok{ }\KeywordTok{monthlyReturn}\NormalTok{(}\KeywordTok{as.xts}\NormalTok{(MPF.BCT}\OperatorTok{$}\NormalTok{CT), }\DataTypeTok{type =} \StringTok{"log"}\NormalTok{)}
\NormalTok{MPF.BCT.EU <-}\StringTok{ }\KeywordTok{monthlyReturn}\NormalTok{(}\KeywordTok{as.xts}\NormalTok{(MPF.BCT}\OperatorTok{$}\NormalTok{EU), }\DataTypeTok{type =} \StringTok{"log"}\NormalTok{)}
\NormalTok{MPF.BCT.E3 <-}\StringTok{ }\KeywordTok{monthlyReturn}\NormalTok{(}\KeywordTok{as.xts}\NormalTok{(MPF.BCT}\OperatorTok{$}\NormalTok{E30), }\DataTypeTok{type =} \StringTok{"log"}\NormalTok{)}
\NormalTok{MPF.BCT.E5 <-}\StringTok{ }\KeywordTok{monthlyReturn}\NormalTok{(}\KeywordTok{as.xts}\NormalTok{(MPF.BCT}\OperatorTok{$}\NormalTok{E50), }\DataTypeTok{type =} \StringTok{"log"}\NormalTok{)}
\NormalTok{MPF.BCT.E7 <-}\StringTok{ }\KeywordTok{monthlyReturn}\NormalTok{(}\KeywordTok{as.xts}\NormalTok{(MPF.BCT}\OperatorTok{$}\NormalTok{E70), }\DataTypeTok{type =} \StringTok{"log"}\NormalTok{)}
\NormalTok{MPF.BCT.E9 <-}\StringTok{ }\KeywordTok{monthlyReturn}\NormalTok{(}\KeywordTok{as.xts}\NormalTok{(MPF.BCT}\OperatorTok{$}\NormalTok{E90), }\DataTypeTok{type =} \StringTok{"log"}\NormalTok{)}
\NormalTok{MPF.BCT.FM <-}\StringTok{ }\KeywordTok{monthlyReturn}\NormalTok{(}\KeywordTok{as.xts}\NormalTok{(MPF.BCT}\OperatorTok{$}\NormalTok{FM), }\DataTypeTok{type =} \StringTok{"log"}\NormalTok{)}

\NormalTok{MPF.BCT.GB <-}\StringTok{ }\KeywordTok{monthlyReturn}\NormalTok{(}\KeywordTok{as.xts}\NormalTok{(MPF.BCT}\OperatorTok{$}\NormalTok{GB), }\DataTypeTok{type =} \StringTok{"log"}\NormalTok{)}
\NormalTok{MPF.BCT.GE <-}\StringTok{ }\KeywordTok{monthlyReturn}\NormalTok{(}\KeywordTok{as.xts}\NormalTok{(MPF.BCT}\OperatorTok{$}\NormalTok{GE), }\DataTypeTok{type =} \StringTok{"log"}\NormalTok{)}
\NormalTok{MPF.BCT.GT <-}\StringTok{ }\KeywordTok{monthlyReturn}\NormalTok{(}\KeywordTok{as.xts}\NormalTok{(MPF.BCT}\OperatorTok{$}\NormalTok{GT), }\DataTypeTok{type =} \StringTok{"log"}\NormalTok{)}
\NormalTok{MPF.BCT.HKB <-}\StringTok{ }\KeywordTok{monthlyReturn}\NormalTok{(}\KeywordTok{as.xts}\NormalTok{(MPF.BCT}\OperatorTok{$}\NormalTok{HKB), }\DataTypeTok{type =} \StringTok{"log"}\NormalTok{)}
\NormalTok{MPF.BCT.HSIT <-}\StringTok{ }\KeywordTok{monthlyReturn}\NormalTok{(}\KeywordTok{as.xts}\NormalTok{(MPF.BCT}\OperatorTok{$}\NormalTok{HSIT), }\DataTypeTok{type =} \StringTok{"log"}\NormalTok{)}
\NormalTok{MPF.BCT.MPFC <-}\StringTok{ }\KeywordTok{monthlyReturn}\NormalTok{(}\KeywordTok{as.xts}\NormalTok{(MPF.BCT}\OperatorTok{$}\NormalTok{MPFC), }\DataTypeTok{type =} \StringTok{"log"}\NormalTok{)}
\NormalTok{MPF.BCT.RMBB <-}\StringTok{ }\KeywordTok{monthlyReturn}\NormalTok{(}\KeywordTok{as.xts}\NormalTok{(MPF.BCT}\OperatorTok{$}\NormalTok{RMBB), }\DataTypeTok{type =} \StringTok{"log"}\NormalTok{)}
\NormalTok{MPF.BCT.SFP <-}\StringTok{ }\KeywordTok{monthlyReturn}\NormalTok{(}\KeywordTok{as.xts}\NormalTok{(MPF.BCT}\OperatorTok{$}\NormalTok{SFP), }\DataTypeTok{type =} \StringTok{"log"}\NormalTok{)}
\NormalTok{MPF.BCT.SE40 <-}\StringTok{ }\KeywordTok{monthlyReturn}\NormalTok{(}\KeywordTok{as.xts}\NormalTok{(MPF.BCT}\OperatorTok{$}\NormalTok{SE2040), }\DataTypeTok{type =} \StringTok{"log"}\NormalTok{)}


\NormalTok{MPF.BCT.returns <-}
\StringTok{  }\KeywordTok{merge}\NormalTok{(}
\NormalTok{    MPF.BCT.AE,}
\NormalTok{    MPF.BCT.CA,}
\NormalTok{    MPF.BCT.CEHK,}
\NormalTok{    MPF.BCT.CT,}
\NormalTok{    MPF.BCT.EU,}
\NormalTok{    MPF.BCT.E3,}
\NormalTok{    MPF.BCT.E5,}
\NormalTok{    MPF.BCT.E7,}
\NormalTok{    MPF.BCT.E9,}
\NormalTok{    MPF.BCT.FM,}
\NormalTok{    MPF.BCT.GB,}
\NormalTok{    MPF.BCT.GE,}
\NormalTok{    MPF.BCT.GT,}
\NormalTok{    MPF.BCT.HKB,}
\NormalTok{    MPF.BCT.HSIT,}
\NormalTok{    MPF.BCT.MPFC,}
\NormalTok{    MPF.BCT.RMBB,}
\NormalTok{    MPF.BCT.SFP,}
\NormalTok{    MPF.BCT.SE40}
\NormalTok{  )}

\NormalTok{MPF.BCT.original.cost <-}
\StringTok{  }\KeywordTok{c}\NormalTok{(}
    \FloatTok{0.0182}\NormalTok{,}
    \FloatTok{0.0085}\NormalTok{,}
    \FloatTok{0.0166}\NormalTok{,}
    \FloatTok{0.0115}\NormalTok{,}
    \FloatTok{0.0165}\NormalTok{,}
    \FloatTok{0.0163}\NormalTok{,}
    \FloatTok{0.0163}\NormalTok{,}
    \FloatTok{0.0162}\NormalTok{,}
    \FloatTok{0.0152}\NormalTok{,}
    \FloatTok{0.0136}\NormalTok{,}
    \FloatTok{0.0150}\NormalTok{,}
    \FloatTok{0.0167}\NormalTok{,}
    \FloatTok{0.0100}\NormalTok{,}
    \FloatTok{0.0112}\NormalTok{,}
    \FloatTok{0.0084}\NormalTok{,}
    \FloatTok{0.0094}\NormalTok{,}
    \FloatTok{0.0126}\NormalTok{,}
    \FloatTok{0.0082}\NormalTok{,}
    \FloatTok{0.0150}
\NormalTok{  ) }\OperatorTok{/}\StringTok{ }\DecValTok{12}
\NormalTok{MPF.BCT.cs.cost <-}
\StringTok{  }\KeywordTok{c}\NormalTok{(}
    \FloatTok{0.0069}\NormalTok{,}
    \FloatTok{0.0062}\NormalTok{,}
    \FloatTok{0.0069}\NormalTok{,}
    \FloatTok{0.0060}\NormalTok{,}
    \FloatTok{0.0069}\NormalTok{,}
    \FloatTok{0.0062}\NormalTok{,}
    \FloatTok{0.0062}\NormalTok{,}
    \FloatTok{0.0062}\NormalTok{,}
    \FloatTok{0.0062}\NormalTok{,}
    \FloatTok{0.0062}\NormalTok{,}
    \FloatTok{0.0055}\NormalTok{,}
    \FloatTok{0.0069}\NormalTok{,}
    \FloatTok{0.0060}\NormalTok{,}
    \FloatTok{0.0055}\NormalTok{,}
    \FloatTok{0.0050}\NormalTok{,}
    \FloatTok{0.0040}\NormalTok{,}
    \FloatTok{0.0055}\NormalTok{,}
    \FloatTok{0.0062}\NormalTok{,}
    \FloatTok{0.0062}
\NormalTok{  ) }\OperatorTok{/}\StringTok{ }\DecValTok{12}

\ControlFlowTok{for}\NormalTok{ (col }\ControlFlowTok{in} \DecValTok{1}\OperatorTok{:}\KeywordTok{length}\NormalTok{(MPF.BCT.returns[}\DecValTok{1}\NormalTok{, ])) \{}
\NormalTok{  MPF.BCT.returns[, col] <-}
\StringTok{    }\NormalTok{MPF.BCT.returns[, col] }\OperatorTok{-}\StringTok{ }\NormalTok{MPF.BCT.cs.cost[col] }\OperatorTok{+}\StringTok{ }\NormalTok{MPF.BCT.original.cost[col]}
\NormalTok{\}}


\NormalTok{monthly <-}\StringTok{ }\KeywordTok{index}\NormalTok{(MPF.BCT.returns)}
\CommentTok{#monthly <- length(monthly)}
\KeywordTok{colnames}\NormalTok{(MPF.BCT.returns) <-}
\StringTok{  }\KeywordTok{c}\NormalTok{(}
    \StringTok{"MPF.BCT.AE"}\NormalTok{,}
    \StringTok{"MPF.BCT.CA"}\NormalTok{,}
    \StringTok{"MPF.BCT.CEHK"}\NormalTok{,}
    \StringTok{"MPF.BCT.CT"}\NormalTok{,}
    \StringTok{"MPF.BCT.EU"}\NormalTok{,}
    \StringTok{"MPF.BCT.E3"}\NormalTok{,}
    \StringTok{"MPF.BCT.E5"}\NormalTok{,}
    \StringTok{"MPF.BCT.E7"}\NormalTok{,}
    \StringTok{"MPF.BCT.E9"}\NormalTok{,}
    \StringTok{"MPF.BCT.FM"}\NormalTok{,}
    \StringTok{"MPF.BCT.GB"}\NormalTok{,}
    \StringTok{"MPF.BCT.GE"}\NormalTok{,}
    \StringTok{"MPF.BCT.GT"}\NormalTok{,}
    \StringTok{"MPF.BCT.HKB"}\NormalTok{,}
    \StringTok{"MPF.BCT.HSIT"}\NormalTok{,}
    \StringTok{"MPF.BCT.MPFC"}\NormalTok{,}
    \StringTok{"MPF.BCT.RMBB"}\NormalTok{,}
    \StringTok{"MPF.BCT.SFP"}\NormalTok{,}
    \StringTok{"MPF.BCT.SE2040"}
\NormalTok{  )}

\KeywordTok{rm}\NormalTok{(}
\NormalTok{  MPF.BCT.AE,}
\NormalTok{  MPF.BCT.CA,}
\NormalTok{  MPF.BCT.CEHK,}
\NormalTok{  MPF.BCT.CT,}
\NormalTok{  MPF.BCT.EU,}
\NormalTok{  MPF.BCT.E3,}
\NormalTok{  MPF.BCT.E5,}
\NormalTok{  MPF.BCT.E7,}
\NormalTok{  MPF.BCT.E9,}
\NormalTok{  MPF.BCT.FM,}
\NormalTok{  MPF.BCT.GB,}
\NormalTok{  MPF.BCT.GE,}
\NormalTok{  MPF.BCT.GT,}
\NormalTok{  MPF.BCT.HKB,}
\NormalTok{  MPF.BCT.HSIT,}
\NormalTok{  MPF.BCT.MPFC,}
\NormalTok{  MPF.BCT.RMBB,}
\NormalTok{  MPF.BCT.SFP,}
\NormalTok{  MPF.BCT.SE40}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{calculate-average-rsi-of-the-month-and-then-adjustment-factor}{%
\subsubsection{Calculate average RSI of the month, and then adjustment
factor}\label{calculate-average-rsi-of-the-month-and-then-adjustment-factor}}

Adjustment factor = 1 - ECDF of RSI of that month New weight = old
weight * (0.05 + adjustment factor) Finally normalize it to sum(row) = 1

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{MPF.BCT.RSI.month <-}
\StringTok{  }\KeywordTok{as.xts}\NormalTok{(}\KeywordTok{do.call}\NormalTok{(rbind, }\KeywordTok{lapply}\NormalTok{(}\KeywordTok{split}\NormalTok{(}\KeywordTok{as.xts}\NormalTok{(MPF.BCT.RSI), }\StringTok{"months"}\NormalTok{), }\ControlFlowTok{function}\NormalTok{(x)}
    \KeywordTok{colAvgs}\NormalTok{(x))), }\DataTypeTok{order.by =}\NormalTok{ monthly)}
\NormalTok{MPF.BCT.RSI.p <-}\StringTok{ }\NormalTok{MPF.BCT.returns}
\NormalTok{MPF.BCT.RSI.p[, ] <-}\StringTok{ }\DecValTok{0}
\ControlFlowTok{for}\NormalTok{ (col }\ControlFlowTok{in} \DecValTok{1}\OperatorTok{:}\KeywordTok{length}\NormalTok{(MPF.BCT.RSI.month[}\DecValTok{1}\NormalTok{, ])) \{}
  \ControlFlowTok{if}\NormalTok{ (col }\OperatorTok{!=}\StringTok{ }\DecValTok{16}\NormalTok{) \{}
    \ControlFlowTok{for}\NormalTok{ (row }\ControlFlowTok{in} \DecValTok{1}\OperatorTok{:}\KeywordTok{length}\NormalTok{(MPF.BCT.RSI.month[, col])) \{}
\NormalTok{      percentile <-}\StringTok{ }\KeywordTok{ecdf}\NormalTok{(}\KeywordTok{as.numeric}\NormalTok{(MPF.BCT.RSI.month[}\DecValTok{1}\OperatorTok{:}\NormalTok{row, col]))}
      \ControlFlowTok{if}\NormalTok{ (}\KeywordTok{percentile}\NormalTok{(MPF.BCT.RSI.month[row, col]) }\OperatorTok{>=}\StringTok{ }\NormalTok{(RSI_Overbuy }\OperatorTok{-}\StringTok{ }\NormalTok{((}\KeywordTok{length}\NormalTok{(}\DecValTok{1}\OperatorTok{:}\NormalTok{row) }\OperatorTok{^}
\StringTok{                                                                      }\NormalTok{(}\DecValTok{1} \OperatorTok{/}\StringTok{ }\DecValTok{3}\NormalTok{)) }\OperatorTok{/}\StringTok{ }\NormalTok{(}\KeywordTok{length}\NormalTok{(}\DecValTok{1}\OperatorTok{:}\NormalTok{row) }\OperatorTok{^}\StringTok{ }\NormalTok{(}\DecValTok{1} \OperatorTok{/}\StringTok{ }\DecValTok{2}\NormalTok{))))) \{}
\NormalTok{        MPF.BCT.RSI.p[row, col] <-}\StringTok{ }\FloatTok{0.4}
\NormalTok{      \} }\ControlFlowTok{else}\NormalTok{ \{}
\NormalTok{        MPF.BCT.RSI.p[row, col] <-}
\StringTok{          }\FloatTok{1.4} \OperatorTok{-}\StringTok{ }\NormalTok{(}\KeywordTok{percentile}\NormalTok{(MPF.BCT.RSI.month[row, col]) }\OperatorTok{^}\StringTok{ }\DecValTok{2}\NormalTok{)}
\NormalTok{      \}}
\NormalTok{    \}}
    
\NormalTok{  \} }\ControlFlowTok{else}\NormalTok{ \{}
\NormalTok{    MPF.BCT.RSI.p[, col] <-}\StringTok{ }\DecValTok{1}
\NormalTok{  \}}
\NormalTok{\}}
\NormalTok{MPF.BCT.RSI.sum <-}
\StringTok{  }\KeywordTok{as.xts}\NormalTok{(}\KeywordTok{rowSums}\NormalTok{(MPF.BCT.RSI.p), }\DataTypeTok{order.by =}\NormalTok{ monthly)}
\ControlFlowTok{for}\NormalTok{ (row }\ControlFlowTok{in} \DecValTok{1}\OperatorTok{:}\KeywordTok{length}\NormalTok{(MPF.BCT.RSI.p[, col])) \{}
\NormalTok{  MPF.BCT.RSI.p[row, ] =}\StringTok{ }\KeywordTok{apply}\NormalTok{(MPF.BCT.RSI.p[row, ], }\DecValTok{2}\NormalTok{, }\ControlFlowTok{function}\NormalTok{(x)}
\NormalTok{    (x }\OperatorTok{/}\StringTok{ }\NormalTok{MPF.BCT.RSI.sum[row, }\DecValTok{1}\NormalTok{]) }\OperatorTok{^}\StringTok{ }\NormalTok{(}\FloatTok{0.25}\NormalTok{))}
\NormalTok{\}}
\NormalTok{MPF.BCT.RSI.sum <-}
\StringTok{  }\KeywordTok{as.xts}\NormalTok{(}\KeywordTok{rowSums}\NormalTok{(MPF.BCT.RSI.p), }\DataTypeTok{order.by =}\NormalTok{ monthly)}
\end{Highlighting}
\end{Shaded}

\hypertarget{train-and-predict-with-long-short-term-memory-lstm-model}{%
\subsubsection{Train and predict with Long Short Term Memory (LSTM)
model}\label{train-and-predict-with-long-short-term-memory-lstm-model}}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{use_python}\NormalTok{(}\StringTok{"~/tensorflow_v2/bin/python"}\NormalTok{)}
\CommentTok{#use_condaenv("~/anaconda3/envs/cntk-py35")}
\KeywordTok{use_implementation}\NormalTok{(}\StringTok{"tensorflow"}\NormalTok{)}
\KeywordTok{use_backend}\NormalTok{(}\StringTok{"tensorflow"}\NormalTok{)}

\NormalTok{MPF.BCT.w.all <-}\StringTok{ }\KeywordTok{array}\NormalTok{(MPF.BCT.returns,}
                       \KeywordTok{c}\NormalTok{(}\KeywordTok{length}\NormalTok{(MPF.BCT.returns[, }\DecValTok{1}\NormalTok{]), }\KeywordTok{length}\NormalTok{(MPF.BCT.returns[}\DecValTok{1}\NormalTok{,]), }\DecValTok{30}\NormalTok{))}

\NormalTok{MPF.BCT.w.all[, ,] <-}\StringTok{ }\DecValTok{0}

\ControlFlowTok{for}\NormalTok{ (pass }\ControlFlowTok{in} \DecValTok{1}\OperatorTok{:}\DecValTok{30}\NormalTok{) \{}
  \ControlFlowTok{for}\NormalTok{ (col }\ControlFlowTok{in} \DecValTok{1}\OperatorTok{:}\KeywordTok{length}\NormalTok{(MPF.BCT.returns[}\DecValTok{1}\NormalTok{, ])) \{}
    \ControlFlowTok{for}\NormalTok{ (row }\ControlFlowTok{in} \DecValTok{1}\OperatorTok{:}\NormalTok{monthly.old) \{}
\NormalTok{      MPF.BCT.w.all[row, col, pass] <-}\StringTok{ }\NormalTok{MPF.BCT.w.all.backup[row, col, pass]}
\NormalTok{    \}}
\NormalTok{  \}}
\NormalTok{\}}

\CommentTok{#MPF.BCT.period <- length(MPF.BCT.w.all[(monthly.existing+1):(monthly.new),1,1])}
\NormalTok{MPF.BCT.period <-}\StringTok{ }\KeywordTok{length}\NormalTok{(MPF.BCT.w.all[, }\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{])}

\NormalTok{max_return <-}\StringTok{ }\KeywordTok{c}\NormalTok{()}
\NormalTok{min_return <-}\StringTok{ }\KeywordTok{c}\NormalTok{()}

\ControlFlowTok{for}\NormalTok{ (col }\ControlFlowTok{in} \DecValTok{1}\OperatorTok{:}\KeywordTok{length}\NormalTok{(MPF.BCT.returns[}\DecValTok{1}\NormalTok{,])) \{}
\NormalTok{  max_return[col] <-}\StringTok{ }\KeywordTok{max}\NormalTok{(}\KeywordTok{na.omit}\NormalTok{(MPF.BCT.returns[, col]))}
\NormalTok{  min_return[col] <-}\StringTok{ }\KeywordTok{min}\NormalTok{(}\KeywordTok{na.omit}\NormalTok{(MPF.BCT.returns[, col]))}
\NormalTok{\}}

\NormalTok{MPF.BCT.returns_normalized <-}\StringTok{ }\NormalTok{MPF.BCT.returns}
\NormalTok{MPF.BCT.returns_normalized[,] <-}\StringTok{ }\DecValTok{0}

\ControlFlowTok{for}\NormalTok{ (col }\ControlFlowTok{in} \DecValTok{1}\OperatorTok{:}\KeywordTok{length}\NormalTok{(MPF.BCT.returns[}\DecValTok{1}\NormalTok{,])) \{}
\NormalTok{  MPF.BCT.returns_normalized[, col] <-}
\StringTok{    }\NormalTok{((MPF.BCT.returns[, col] }\OperatorTok{-}\StringTok{ }\NormalTok{min_return[col]) }\OperatorTok{/}\StringTok{ }\NormalTok{(max_return[col] }\OperatorTok{-}\StringTok{ }\NormalTok{min_return[col])) }\OperatorTok{*}\StringTok{ }\DecValTok{2} \OperatorTok{-}\StringTok{ }\DecValTok{1}
\NormalTok{\}}

\NormalTok{temp <-}\StringTok{ }\KeywordTok{as.matrix}\NormalTok{(MPF.BCT.returns_normalized)}
\NormalTok{colNum <-}\StringTok{ }\DecValTok{1}\OperatorTok{:}\KeywordTok{length}\NormalTok{(MPF.BCT.returns_normalized[}\DecValTok{1}\NormalTok{,])}
\NormalTok{matrix <-}\StringTok{ }\KeywordTok{c}\NormalTok{()}

\NormalTok{seed <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}
  \DecValTok{71880}\NormalTok{,}
  \DecValTok{21251}\NormalTok{,}
  \DecValTok{98689}\NormalTok{,}
  \DecValTok{65940}\NormalTok{,}
  \DecValTok{22528}\NormalTok{,}
  \DecValTok{5447}\NormalTok{,}
  \DecValTok{13014}\NormalTok{,}
  \DecValTok{49976}\NormalTok{,}
  \DecValTok{57549}\NormalTok{,}
  \DecValTok{95690}\NormalTok{,}
  \DecValTok{18466}\NormalTok{,}
  \DecValTok{46047}\NormalTok{,}
  \DecValTok{55070}\NormalTok{,}
  \DecValTok{9292}\NormalTok{,}
  \DecValTok{82205}\NormalTok{,}
  \DecValTok{88714}\NormalTok{,}
  \DecValTok{38882}\NormalTok{,}
  \DecValTok{58473}\NormalTok{,}
  \DecValTok{75294}\NormalTok{,}
  \DecValTok{66679}\NormalTok{,}
  \DecValTok{68541}\NormalTok{,}
  \DecValTok{42252}\NormalTok{,}
  \DecValTok{41907}\NormalTok{,}
  \DecValTok{37306}\NormalTok{,}
  \DecValTok{75969}\NormalTok{,}
  \DecValTok{997}\NormalTok{,}
  \DecValTok{5609}\NormalTok{,}
  \DecValTok{95359}\NormalTok{,}
  \DecValTok{75506}\NormalTok{,}
  \DecValTok{93963}
\NormalTok{)}
\NormalTok{seed.int <-}\StringTok{ }\KeywordTok{as.integer}\NormalTok{(seed)}

\NormalTok{tensorflow}\OperatorTok{::}\NormalTok{tf}\OperatorTok{$}\NormalTok{config}\OperatorTok{$}\NormalTok{optimizer}\OperatorTok{$}\KeywordTok{set_jit}\NormalTok{(}\OtherTok{TRUE}\NormalTok{)}
\NormalTok{tensorflow}\OperatorTok{::}\NormalTok{tf}\OperatorTok{$}\NormalTok{config}\OperatorTok{$}\NormalTok{threading}\OperatorTok{$}\KeywordTok{set_intra_op_parallelism_threads}\NormalTok{(8L)}
\NormalTok{tensorflow}\OperatorTok{::}\NormalTok{tf}\OperatorTok{$}\NormalTok{config}\OperatorTok{$}\NormalTok{threading}\OperatorTok{$}\KeywordTok{set_inter_op_parallelism_threads}\NormalTok{(16L)}
\NormalTok{tensorflow}\OperatorTok{::}\NormalTok{tf}\OperatorTok{$}\NormalTok{keras}\OperatorTok{$}\NormalTok{backend}\OperatorTok{$}\KeywordTok{set_floatx}\NormalTok{(}\StringTok{'float32'}\NormalTok{)}

\ControlFlowTok{for}\NormalTok{ (pass }\ControlFlowTok{in} \DecValTok{1}\OperatorTok{:}\DecValTok{30}\NormalTok{) \{}
\NormalTok{  learning <-}\StringTok{ }\FloatTok{0.0013}
\NormalTok{  n_steps <-}\StringTok{ }\DecValTok{3}
  
  
\NormalTok{  tensorflow}\OperatorTok{::}\NormalTok{tf}\OperatorTok{$}\NormalTok{random}\OperatorTok{$}\KeywordTok{set_seed}\NormalTok{(seed[pass])}
  \CommentTok{#use_session_with_seed(seed[pass], FALSE, FALSE)}
  
\NormalTok{  model <-}\StringTok{ }\KeywordTok{keras_model_sequential}\NormalTok{()}
\NormalTok{  model }\OperatorTok{%>%}\StringTok{ }\KeywordTok{layer_lstm}\NormalTok{(}
    \DataTypeTok{units =} \DecValTok{64}\NormalTok{,}
    \DataTypeTok{activation =} \StringTok{"tanh"}\NormalTok{,}
    \DataTypeTok{input_shape =} \KeywordTok{c}\NormalTok{(}\DecValTok{60}\NormalTok{, }\DecValTok{1}\NormalTok{),}
    \DataTypeTok{return_sequences =} \OtherTok{TRUE}\NormalTok{,}
    \DataTypeTok{dtype =} \StringTok{'float32'}
    \CommentTok{#kernel_initializer = initializer_glorot_normal(seed[pass])}
\NormalTok{  ) }\OperatorTok{%>%}
\StringTok{    }\KeywordTok{layer_lstm}\NormalTok{(}
      \DataTypeTok{units =} \DecValTok{16}\NormalTok{,}
      \DataTypeTok{activation =} \StringTok{"tanh"}\NormalTok{,}
      \DataTypeTok{return_sequences =} \OtherTok{TRUE}\NormalTok{,}
      \DataTypeTok{dtype =} \StringTok{'float32'}
      \CommentTok{#kernel_initializer = initializer_glorot_normal(seed[pass])}
\NormalTok{    ) }\OperatorTok{%>%}
\StringTok{    }\KeywordTok{layer_lstm}\NormalTok{(}\DataTypeTok{units =} \DecValTok{4}\NormalTok{,}
               \DataTypeTok{activation =} \StringTok{"tanh"}\NormalTok{,}
               \DataTypeTok{dtype =} \StringTok{'float32'}
               \CommentTok{#,}
               \CommentTok{#kernel_initializer = initializer_glorot_normal(seed[pass])) %>%}
               \KeywordTok{layer_dense}\NormalTok{(}\DecValTok{1}\NormalTok{)}
               
               
               
\NormalTok{               ad <-}\StringTok{ }\NormalTok{keras}\OperatorTok{::}\KeywordTok{optimizer_adam}\NormalTok{(}\DataTypeTok{lr =}\NormalTok{ learning)}
\NormalTok{               model }\OperatorTok{%>%}\StringTok{ }\KeywordTok{compile}\NormalTok{(}\DataTypeTok{optimizer =}\NormalTok{ ad, }\DataTypeTok{loss =} \StringTok{"mean_squared_error"}\NormalTok{)}
               
               
               \ControlFlowTok{for}\NormalTok{ (col }\ControlFlowTok{in}\NormalTok{ colNum) \{}
\NormalTok{                 X <-}\StringTok{ }\KeywordTok{c}\NormalTok{()}
\NormalTok{                 y <-}\StringTok{ }\KeywordTok{c}\NormalTok{()}
                 
\NormalTok{                 counter <-}\StringTok{ }\DecValTok{0}
\NormalTok{                 minimum <-}\StringTok{ }\DecValTok{4}
                 
                 
\NormalTok{                 X <-}\StringTok{ }\KeywordTok{as.matrix}\NormalTok{(}\KeywordTok{na.omit}\NormalTok{(MPF.BCT.returns_normalized[, col]))}
                 \CommentTok{#X_old <- length(na.omit(MPF.BCT.w.all.backup[,col,1]))}
\NormalTok{                 y <-}
\StringTok{                   }\KeywordTok{as.matrix}\NormalTok{(}\KeywordTok{na.omit}\NormalTok{(}\KeywordTok{lag}\NormalTok{(}
                     \KeywordTok{na.omit}\NormalTok{(MPF.BCT.returns_normalized[, col]), }\DecValTok{-1}
\NormalTok{                   )))}
                 
\NormalTok{                 predicted <-}\StringTok{ }\KeywordTok{c}\NormalTok{()}
\NormalTok{                 len <-}\StringTok{ }\DecValTok{1}
                 
                 \CommentTok{#for (i in X_old:(length(X)-1)) \{}
                 \ControlFlowTok{if}\NormalTok{ (}\KeywordTok{length}\NormalTok{(X) }\OperatorTok{<}\StringTok{ }\DecValTok{62}\NormalTok{) \{}
\NormalTok{                   predicted <-}\StringTok{ }\KeywordTok{rep}\NormalTok{(}\DecValTok{0}\NormalTok{, }\KeywordTok{length}\NormalTok{(}\DecValTok{1}\OperatorTok{:}\NormalTok{(}\KeywordTok{length}\NormalTok{(}
\NormalTok{                     MPF.BCT.returns}
\NormalTok{                   ))))}
\NormalTok{                 \} }\ControlFlowTok{else}\NormalTok{ \{}
                   \CommentTok{#for (i in 62:length(X) - 1) \{}
\NormalTok{                   i <-}\StringTok{ }\KeywordTok{length}\NormalTok{(X) }\OperatorTok{-}\StringTok{ }\DecValTok{1}
                   
                   
\NormalTok{                   split_seq <-}\StringTok{ }\ControlFlowTok{function}\NormalTok{(sequence_c, }\DataTypeTok{n_steps =} \DecValTok{120}\NormalTok{) \{}
\NormalTok{                     X <-}\StringTok{ }\KeywordTok{c}\NormalTok{()}
\NormalTok{                     y <-}\StringTok{ }\KeywordTok{c}\NormalTok{()}
                     
                     \ControlFlowTok{for}\NormalTok{ (idx }\ControlFlowTok{in} \DecValTok{1}\OperatorTok{:}\KeywordTok{length}\NormalTok{(sequence_c)) \{}
\NormalTok{                       end_ix <-}\StringTok{ }\NormalTok{idx }\OperatorTok{+}\StringTok{ }\NormalTok{n_steps}
                       \ControlFlowTok{if}\NormalTok{ (end_ix }\OperatorTok{>}\StringTok{ }\KeywordTok{length}\NormalTok{(sequence_c)) \{}
                         \ControlFlowTok{break}
\NormalTok{                       \}}
\NormalTok{                       seq_x <-}\StringTok{ }\NormalTok{sequence_c[idx}\OperatorTok{:}\NormalTok{(end_ix }\OperatorTok{-}\StringTok{ }\DecValTok{1}\NormalTok{)]}
\NormalTok{                       seq_y <-}\StringTok{ }\NormalTok{sequence_c[end_ix]}
\NormalTok{                       X <-}\StringTok{ }\KeywordTok{c}\NormalTok{(X, seq_x)}
\NormalTok{                       y <-}\StringTok{ }\KeywordTok{c}\NormalTok{(y, seq_y)}
\NormalTok{                     \}}
\NormalTok{                     X_mat <-}\StringTok{ }\KeywordTok{matrix}\NormalTok{(X, }\DataTypeTok{ncol =}\NormalTok{ n_steps, }\DataTypeTok{byrow =} \OtherTok{FALSE}\NormalTok{)}
\NormalTok{                     y_mat <-}\StringTok{ }\KeywordTok{matrix}\NormalTok{(y, }\DataTypeTok{byrow =} \OtherTok{TRUE}\NormalTok{)}
                     \KeywordTok{list}\NormalTok{(}\DataTypeTok{X =}\NormalTok{ X_mat, }\DataTypeTok{y =}\NormalTok{ y_mat)}
\NormalTok{                   \}}
                   
                   \CommentTok{#X_train <- split_seq(X[1:i], 60)$X}
                   \CommentTok{#y_train <- split_seq(y[1:i], 60)$}
                   
\NormalTok{                   X_train <-}\StringTok{ }\KeywordTok{rollapply}\NormalTok{(}
\NormalTok{                     X[}\DecValTok{1}\OperatorTok{:}\NormalTok{(i)],}
                     \DataTypeTok{FUN =} \ControlFlowTok{function}\NormalTok{(x) \{}
\NormalTok{                       na <-}\StringTok{ }\KeywordTok{rep}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{60}\NormalTok{)}
                       \ControlFlowTok{if}\NormalTok{ (}\KeywordTok{length}\NormalTok{(x) }\OperatorTok{==}\StringTok{ }\DecValTok{60}\NormalTok{) \{}
                         \ControlFlowTok{for}\NormalTok{ (i }\ControlFlowTok{in}\NormalTok{ (}\DecValTok{61} \OperatorTok{-}\StringTok{ }\KeywordTok{length}\NormalTok{(x))}\OperatorTok{:}\DecValTok{60}\NormalTok{) \{}
\NormalTok{                           na[i] <-}\StringTok{ }\NormalTok{x[i]}
\NormalTok{                         \}}
\NormalTok{                         na}
\NormalTok{                       \} }\ControlFlowTok{else}\NormalTok{ \{}
                         \ControlFlowTok{for}\NormalTok{ (i }\ControlFlowTok{in} \KeywordTok{length}\NormalTok{(x)}\OperatorTok{:}\DecValTok{1}\NormalTok{) \{}
\NormalTok{                           na[}\KeywordTok{length}\NormalTok{(x) }\OperatorTok{-}\StringTok{ }\NormalTok{i }\OperatorTok{+}\StringTok{ }\DecValTok{1}\NormalTok{] <-}\StringTok{ }\NormalTok{x[i]}
\NormalTok{                         \}}
                         \KeywordTok{rev}\NormalTok{(na)}
\NormalTok{                       \}}
\NormalTok{                     \},}
                     \DataTypeTok{width =} \DecValTok{60}\NormalTok{,}
                     \DataTypeTok{partial =} \OtherTok{TRUE}\NormalTok{,}
                     \DataTypeTok{fill =} \OtherTok{NA}\NormalTok{,}
                     \DataTypeTok{align =} \StringTok{"right"}
\NormalTok{                   )}
\NormalTok{                   y_train <-}
\StringTok{                     }\KeywordTok{rollapply}\NormalTok{(}
\NormalTok{                       y[}\DecValTok{1}\OperatorTok{:}\NormalTok{(i)],}
                       \DataTypeTok{FUN =}\NormalTok{ c,}
                       \DataTypeTok{width =} \DecValTok{1}\NormalTok{,}
                       \DataTypeTok{partial =} \OtherTok{TRUE}\NormalTok{,}
                       \DataTypeTok{fill =} \OtherTok{NA}\NormalTok{,}
                       \DataTypeTok{align =} \StringTok{"right"}
\NormalTok{                     )}
                   
                   \CommentTok{#X_test <- split_seq(X[1:(i+1)], 60)$X}
                   \CommentTok{#y_test <- split_seq(y[1:(i+1)], 60)$y}
                   
                   \KeywordTok{dim}\NormalTok{(X_train) <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\KeywordTok{length}\NormalTok{(X_train[, }\DecValTok{1}\NormalTok{]), }\DecValTok{60}\NormalTok{, }\DecValTok{1}\NormalTok{)}
                   \CommentTok{#dim(X_test) <- c(length(X_test[,1]),60,1)}
                   \CommentTok{# dim(X_train) <- c(length(X_train[,1]), 60)}
                   \CommentTok{# dim(X_test) <- c(length(X_test[,1]),60)}
                   
                   
                   \CommentTok{#dim(X_train) <- c(length(X_train), 60, 1)}
                   \CommentTok{#dim(X_test) <- c(length(X_test), 1, 1)}
                   
\NormalTok{                   history <-}
\StringTok{                     }\NormalTok{model }\OperatorTok{%>%}\StringTok{ }\KeywordTok{fit}\NormalTok{(}
\NormalTok{                       tf}\OperatorTok{$}\KeywordTok{cast}\NormalTok{(X_train, tf}\OperatorTok{$}\NormalTok{float32),}
\NormalTok{                       tf}\OperatorTok{$}\KeywordTok{cast}\NormalTok{(y_train, tf}\OperatorTok{$}\NormalTok{float32),}
                       \DataTypeTok{epochs =} \DecValTok{36}\NormalTok{,}
                       \DataTypeTok{batch_size =} \DecValTok{128}\NormalTok{,}
                       \DataTypeTok{verbose =} \DecValTok{0}
\NormalTok{                     )}
                   \CommentTok{#plot(history,metrics=c('loss'))}
                   
                   
                   \ControlFlowTok{for}\NormalTok{ (loop }\ControlFlowTok{in} \DecValTok{1}\OperatorTok{:}\NormalTok{(}\KeywordTok{length}\NormalTok{(X) }\OperatorTok{-}\StringTok{ }\DecValTok{1}\NormalTok{)) \{}
\NormalTok{                     X_test <-}\StringTok{ }\KeywordTok{rollapply}\NormalTok{(}
\NormalTok{                       X[}\DecValTok{1}\OperatorTok{:}\NormalTok{(loop }\OperatorTok{+}\StringTok{ }\DecValTok{1}\NormalTok{)],}
                       \DataTypeTok{FUN =} \ControlFlowTok{function}\NormalTok{(x) \{}
\NormalTok{                         na <-}\StringTok{ }\KeywordTok{rep}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{60}\NormalTok{)}
                         \ControlFlowTok{if}\NormalTok{ (}\KeywordTok{length}\NormalTok{(x) }\OperatorTok{==}\StringTok{ }\DecValTok{60}\NormalTok{) \{}
                           \ControlFlowTok{for}\NormalTok{ (i }\ControlFlowTok{in}\NormalTok{ (}\DecValTok{61} \OperatorTok{-}\StringTok{ }\KeywordTok{length}\NormalTok{(x))}\OperatorTok{:}\DecValTok{60}\NormalTok{) \{}
\NormalTok{                             na[i] <-}\StringTok{ }\NormalTok{x[i]}
\NormalTok{                           \}}
\NormalTok{                           na}
\NormalTok{                         \} }\ControlFlowTok{else}\NormalTok{ \{}
                           \ControlFlowTok{for}\NormalTok{ (i }\ControlFlowTok{in} \KeywordTok{length}\NormalTok{(x)}\OperatorTok{:}\DecValTok{1}\NormalTok{) \{}
\NormalTok{                             na[}\KeywordTok{length}\NormalTok{(x) }\OperatorTok{-}\StringTok{ }\NormalTok{i }\OperatorTok{+}\StringTok{ }\DecValTok{1}\NormalTok{] <-}\StringTok{ }\NormalTok{x[i]}
\NormalTok{                           \}}
                           \KeywordTok{rev}\NormalTok{(na)}
\NormalTok{                         \}}
\NormalTok{                       \},}
                       \DataTypeTok{width =} \DecValTok{60}\NormalTok{,}
                       \DataTypeTok{partial =} \OtherTok{TRUE}\NormalTok{,}
                       \DataTypeTok{fill =} \DecValTok{0}\NormalTok{,}
                       \DataTypeTok{align =} \StringTok{"right"}
\NormalTok{                     )}
                     
                     \KeywordTok{dim}\NormalTok{(X_test) <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\KeywordTok{length}\NormalTok{(X_test[, }\DecValTok{1}\NormalTok{]), }\DecValTok{60}\NormalTok{, }\DecValTok{1}\NormalTok{)}
\NormalTok{                     X_test <-}\StringTok{ }\KeywordTok{tail}\NormalTok{(X_test[, , }\DecValTok{1}\NormalTok{], }\DecValTok{1}\NormalTok{)}
                     \KeywordTok{dim}\NormalTok{(X_test) <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{60}\NormalTok{, }\DecValTok{1}\NormalTok{)}
\NormalTok{                     predicted[len] <-}
\StringTok{                       }\NormalTok{model }\OperatorTok{%>%}\StringTok{ }\KeywordTok{predict}\NormalTok{(X_test, }\DataTypeTok{batch_size =} \DecValTok{128}\NormalTok{)}
\NormalTok{                     len <-}\StringTok{ }\NormalTok{len }\OperatorTok{+}\StringTok{ }\DecValTok{1}
                     
\NormalTok{                   \}}
                   
                   
\NormalTok{                   result.length <-}\StringTok{ }\NormalTok{len }\OperatorTok{-}\StringTok{ }\DecValTok{1}
                   
\NormalTok{                 \}}
                 
                 
                 \CommentTok{#for (row in (monthly.existing + MPF.HSBC.period - result.length+1) :}
                 \CommentTok{#  (monthly.existing + MPF.HSBC.period)) \{}
                 \ControlFlowTok{for}\NormalTok{ (row }\ControlFlowTok{in}\NormalTok{ (MPF.BCT.period }\OperatorTok{-}\StringTok{ }\NormalTok{result.length }\OperatorTok{+}\StringTok{ }\DecValTok{1}\NormalTok{)}\OperatorTok{:}\NormalTok{(MPF.BCT.period)) \{}
\NormalTok{                   MPF.BCT.w.all[row, col, pass] <-}
\StringTok{                     }\NormalTok{predicted[(row }\OperatorTok{+}\StringTok{ }\NormalTok{result.length }\OperatorTok{-}\StringTok{ }\NormalTok{MPF.BCT.period)]}
\NormalTok{                 \}}
\NormalTok{               \}}
               \CommentTok{#keras::k_clear_session()}
\ErrorTok{\}}
\end{Highlighting}
\end{Shaded}

\hypertarget{calculate-the-weight-according-to-predicted-return}{%
\subsubsection{Calculate the weight according to predicted
return}\label{calculate-the-weight-according-to-predicted-return}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{MPF.BCT.w <-}\StringTok{ }\NormalTok{MPF.BCT.returns}
\NormalTok{MPF.BCT.w[, ] <-}\StringTok{ }\DecValTok{0}

\NormalTok{MPF.BCT.w <-}\StringTok{ }\KeywordTok{rowAvgs}\NormalTok{(MPF.BCT.w.all, }\DataTypeTok{dims =} \DecValTok{2}\NormalTok{)}
\NormalTok{MPF.BCT.w[MPF.BCT.w }\OperatorTok{==}\StringTok{ }\DecValTok{0}\NormalTok{] <-}\StringTok{ }\OtherTok{NA}
\ControlFlowTok{for}\NormalTok{ (col }\ControlFlowTok{in} \DecValTok{1}\OperatorTok{:}\KeywordTok{length}\NormalTok{(MPF.BCT.w[}\DecValTok{1}\NormalTok{, ])) \{}
\NormalTok{  MPF.BCT.w[, col] <-}
\StringTok{    }\NormalTok{((MPF.BCT.w[, col] }\OperatorTok{+}\StringTok{ }\DecValTok{1}\NormalTok{) }\OperatorTok{/}\StringTok{ }\DecValTok{2} \OperatorTok{*}\StringTok{ }\NormalTok{(max_return[col] }\OperatorTok{-}\StringTok{ }\NormalTok{min_return[col]) }\OperatorTok{+}\StringTok{ }\NormalTok{min_return[col])}
\NormalTok{\}}



\NormalTok{MPF.portf.weight <-}\StringTok{ }\NormalTok{MPF.BCT.returns}
\NormalTok{MPF.portf.weight[,] <-}\StringTok{ }\OtherTok{NA}
\NormalTok{MPF.portf.weight.all <-}\StringTok{ }\NormalTok{MPF.BCT.returns}
\NormalTok{MPF.portf.weight.all[, ] <-}\StringTok{ }\OtherTok{NA}
\KeywordTok{colnames}\NormalTok{(MPF.portf.weight) <-}
\StringTok{  }\KeywordTok{c}\NormalTok{(}
    \StringTok{"MPF.BCT.AE"}\NormalTok{,}
    \StringTok{"MPF.BCT.CA"}\NormalTok{,}
    \StringTok{"MPF.BCT.CEHK"}\NormalTok{,}
    \StringTok{"MPF.BCT.CT"}\NormalTok{,}
    \StringTok{"MPF.BCT.EU"}\NormalTok{,}
    \StringTok{"MPF.BCT.E3"}\NormalTok{,}
    \StringTok{"MPF.BCT.E5"}\NormalTok{,}
    \StringTok{"MPF.BCT.E7"}\NormalTok{,}
    \StringTok{"MPF.BCT.E9"}\NormalTok{,}
    \StringTok{"MPF.BCT.FM"}\NormalTok{,}
    \StringTok{"MPF.BCT.GB"}\NormalTok{,}
    \StringTok{"MPF.BCT.GE"}\NormalTok{,}
    \StringTok{"MPF.BCT.GT"}\NormalTok{,}
    \StringTok{"MPF.BCT.HKB"}\NormalTok{,}
    \StringTok{"MPF.BCT.HSIT"}\NormalTok{,}
    \StringTok{"MPF.BCT.MPFC"}\NormalTok{,}
    \StringTok{"MPF.BCT.RMBB"}\NormalTok{,}
    \StringTok{"MPF.BCT.SFP"}\NormalTok{,}
    \StringTok{"MPF.BCT.SFP"}\NormalTok{,}
    \StringTok{"MPF.BCT.SE2040"}
\NormalTok{  )}

\NormalTok{MPF.BCT.stock.return <-}
\StringTok{  }\KeywordTok{as.xts}\NormalTok{(}\KeywordTok{rowSums}\NormalTok{(MPF.BCT.RSI.month), }\DataTypeTok{order.by =}\NormalTok{ monthly)}
\NormalTok{MPF.BCT.stock.return[] <-}\StringTok{ }\OtherTok{NA}
\NormalTok{MPF.portf.return <-}
\StringTok{  }\KeywordTok{as.xts}\NormalTok{(}\KeywordTok{rowSums}\NormalTok{(MPF.BCT.RSI.month), }\DataTypeTok{order.by =}\NormalTok{ monthly)}
\NormalTok{MPF.portf.return[] <-}\StringTok{ }\OtherTok{NA}


\NormalTok{MPF.BCT.returns.mat <-}\StringTok{ }\KeywordTok{as.matrix}\NormalTok{(MPF.BCT.returns)}

\NormalTok{MPF.BCT.p <-}\StringTok{ }\KeywordTok{as.matrix}\NormalTok{(MPF.BCT.returns)}
\NormalTok{MPF.BCT.p[,] <-}\StringTok{ }\DecValTok{0}
\NormalTok{SR.all <-}\StringTok{ }\KeywordTok{c}\NormalTok{()}


\NormalTok{hedge <-}\StringTok{ }\OtherTok{FALSE}
\NormalTok{up <-}\StringTok{ }\OtherTok{TRUE}
\NormalTok{round_percent <-}\StringTok{ }\ControlFlowTok{function}\NormalTok{(x) \{}
\NormalTok{  x <-}\StringTok{ }\NormalTok{x }\OperatorTok{*}\StringTok{ }\DecValTok{100}
\NormalTok{  result <-}\StringTok{ }\KeywordTok{floor}\NormalTok{(x)    }\CommentTok{# Find integer bits}
\NormalTok{  remain <-}\StringTok{ }\NormalTok{x }\OperatorTok{-}\StringTok{ }\NormalTok{result}
\NormalTok{  rsum <-}\StringTok{ }\KeywordTok{sum}\NormalTok{(result)   }\CommentTok{# Find out how much we are missing}
\NormalTok{  i <-}\StringTok{ }\DecValTok{1}
  \ControlFlowTok{if}\NormalTok{ (rsum }\OperatorTok{<}\StringTok{ }\DecValTok{100}\NormalTok{) \{}
\NormalTok{    o <-}\StringTok{ }\KeywordTok{order}\NormalTok{(remain, }\DataTypeTok{decreasing =} \OtherTok{TRUE}\NormalTok{)}
    \ControlFlowTok{while}\NormalTok{ (rsum }\OperatorTok{<}\StringTok{ }\DecValTok{100}\NormalTok{) \{}
      \ControlFlowTok{if}\NormalTok{ (i }\OperatorTok{>}\StringTok{ }\KeywordTok{length}\NormalTok{(remain))}
\NormalTok{        i <-}\StringTok{ }\DecValTok{1}
\NormalTok{      idx <-}\StringTok{ }\NormalTok{o[i]}
      \ControlFlowTok{if}\NormalTok{ (result[idx] }\OperatorTok{==}\StringTok{ }\DecValTok{0}\NormalTok{) \{}
\NormalTok{        i <-}\StringTok{ }\NormalTok{i }\OperatorTok{+}\StringTok{ }\DecValTok{1}
        \ControlFlowTok{next}
\NormalTok{      \}}
\NormalTok{      result[idx] <-}\StringTok{ }\NormalTok{result[idx] }\OperatorTok{+}\StringTok{ }\DecValTok{1}
\NormalTok{      rsum <-}\StringTok{ }\KeywordTok{sum}\NormalTok{(result)}
\NormalTok{      i <-}\StringTok{ }\NormalTok{i }\OperatorTok{+}\StringTok{ }\DecValTok{1}
\NormalTok{    \}}
\NormalTok{  \}}
\NormalTok{  result <-}\StringTok{ }\NormalTok{result }\OperatorTok{/}\StringTok{ }\DecValTok{100}
  \KeywordTok{return}\NormalTok{(result)}
\NormalTok{\}}


\ControlFlowTok{for}\NormalTok{ (row }\ControlFlowTok{in} \DecValTok{1}\OperatorTok{:}\KeywordTok{length}\NormalTok{(MPF.BCT.w[, }\DecValTok{1}\NormalTok{])) \{}
\NormalTok{  MPF.BCT.stock.mean <-}\StringTok{ }\DecValTok{0}
\NormalTok{  i <-}\StringTok{ }\DecValTok{0}
  
  \ControlFlowTok{for}\NormalTok{ (col }\ControlFlowTok{in} \DecValTok{1}\OperatorTok{:}\KeywordTok{length}\NormalTok{(MPF.BCT.w[}\DecValTok{1}\NormalTok{,])) \{}
\NormalTok{    MPF.BCT.w[row, col] <-}
\StringTok{      }\KeywordTok{na.fill}\NormalTok{((MPF.BCT.w[row, col]) }\OperatorTok{*}\StringTok{ }\NormalTok{MPF.BCT.RSI.p[row, col], }\DecValTok{0}\NormalTok{)}
    
    \ControlFlowTok{if}\NormalTok{ (col }\OperatorTok{!=}\StringTok{ }\DecValTok{2} \OperatorTok{&&}
\StringTok{        }\NormalTok{col }\OperatorTok{!=}\StringTok{ }\DecValTok{6} \OperatorTok{&&}
\StringTok{        }\NormalTok{col }\OperatorTok{!=}\StringTok{ }\DecValTok{7} \OperatorTok{&&}
\StringTok{        }\NormalTok{col }\OperatorTok{!=}\StringTok{ }\DecValTok{11} \OperatorTok{&&}\StringTok{ }\NormalTok{col }\OperatorTok{!=}\StringTok{ }\DecValTok{14} \OperatorTok{&&}\StringTok{ }\NormalTok{col }\OperatorTok{!=}\StringTok{ }\DecValTok{16} \OperatorTok{&&}\StringTok{ }\NormalTok{col }\OperatorTok{!=}\StringTok{ }\DecValTok{17} \OperatorTok{&&}\StringTok{ }\NormalTok{col }\OperatorTok{!=}\StringTok{ }\DecValTok{18}\NormalTok{) \{}
      \ControlFlowTok{if}\NormalTok{ (}\OperatorTok{!}\KeywordTok{is.na}\NormalTok{(MPF.BCT.returns.mat[row, col]) }\OperatorTok{&&}
\StringTok{          }\NormalTok{MPF.BCT.returns.mat[row, col] }\OperatorTok{!=}\StringTok{ }\DecValTok{0}\NormalTok{) \{}
\NormalTok{        MPF.BCT.stock.mean <-}
\StringTok{          }\NormalTok{MPF.BCT.stock.mean }\OperatorTok{+}\StringTok{ }\NormalTok{MPF.BCT.returns.mat[row, col]}
\NormalTok{        i <-}\StringTok{ }\NormalTok{i }\OperatorTok{+}\StringTok{ }\DecValTok{1}
\NormalTok{      \}}
      
      \ControlFlowTok{if}\NormalTok{ (MPF.BCT.w[row, col] }\OperatorTok{<}\StringTok{ }\FloatTok{1e-6}\NormalTok{) \{}
\NormalTok{        MPF.BCT.w[row, col] <-}\StringTok{ }\DecValTok{0}
\NormalTok{      \}}
\NormalTok{    \} }\ControlFlowTok{else}\NormalTok{ \{}
      \ControlFlowTok{if}\NormalTok{ (MPF.BCT.w[row, col] }\OperatorTok{<}\StringTok{ }\DecValTok{0}\NormalTok{) \{}
\NormalTok{        MPF.BCT.w[row, col] <-}\StringTok{ }\DecValTok{0}
\NormalTok{      \}}
\NormalTok{    \}}
\NormalTok{  \}}
  
\NormalTok{  MPF.BCT.stock.return[row] <-}\StringTok{ }\NormalTok{MPF.BCT.stock.mean }\OperatorTok{/}\StringTok{ }\NormalTok{i}
  
  \CommentTok{# Retain two most increasing fund}
\NormalTok{  last <-}\StringTok{ }\KeywordTok{length}\NormalTok{(MPF.BCT.w[}\DecValTok{1}\NormalTok{,]) }\OperatorTok{-}\StringTok{ }\NormalTok{top}
\NormalTok{  order <-}\StringTok{ }\KeywordTok{order}\NormalTok{(MPF.BCT.w[row,])}
  \ControlFlowTok{for}\NormalTok{ (col }\ControlFlowTok{in}\NormalTok{ order[}\DecValTok{1}\OperatorTok{:}\NormalTok{last]) \{}
\NormalTok{    MPF.BCT.w[row, col] <-}\StringTok{ }\DecValTok{0}
\NormalTok{  \}}
  
  
  
  \ControlFlowTok{if}\NormalTok{ (row }\OperatorTok{>}\StringTok{ }\DecValTok{8} \OperatorTok{&&}
\StringTok{      }\NormalTok{MPF.BCT.stock.return[row] }\OperatorTok{>}
\StringTok{      }\KeywordTok{quantile}\NormalTok{(}\KeywordTok{na.omit}\NormalTok{(MPF.BCT.stock.return), }\KeywordTok{c}\NormalTok{(.}\DecValTok{35}\NormalTok{))  }\OperatorTok{&&}
\StringTok{      }\NormalTok{MPF.BCT.stock.return[row }\OperatorTok{-}\StringTok{ }\DecValTok{3}\NormalTok{] }\OperatorTok{>}
\StringTok{      }\KeywordTok{quantile}\NormalTok{(}\KeywordTok{na.omit}\NormalTok{(MPF.BCT.stock.return), }\KeywordTok{c}\NormalTok{(.}\DecValTok{45}\NormalTok{))) \{}
\NormalTok{    up <-}\StringTok{ }\OtherTok{FALSE}
\NormalTok{  \}}
  
  \ControlFlowTok{if}\NormalTok{ (row }\OperatorTok{>}\StringTok{ }\DecValTok{8} \OperatorTok{&&}\StringTok{ }\NormalTok{hedge }\OperatorTok{&&}
\StringTok{      }\NormalTok{MPF.BCT.stock.return[row] }\OperatorTok{>}
\StringTok{      }\KeywordTok{quantile}\NormalTok{(}\KeywordTok{na.omit}\NormalTok{(MPF.BCT.stock.return), }\KeywordTok{c}\NormalTok{(.}\DecValTok{45}\NormalTok{))  }\OperatorTok{&&}
\StringTok{      }\NormalTok{MPF.BCT.stock.return[row }\OperatorTok{-}\StringTok{ }\DecValTok{3}\NormalTok{] }\OperatorTok{>}
\StringTok{      }\KeywordTok{quantile}\NormalTok{(}\KeywordTok{na.omit}\NormalTok{(MPF.BCT.stock.return), }\KeywordTok{c}\NormalTok{(.}\DecValTok{35}\NormalTok{))) \{}
\NormalTok{    hedge <-}\StringTok{ }\OtherTok{FALSE}
\NormalTok{    up <-}\StringTok{ }\OtherTok{TRUE}
\NormalTok{  \}}
  
  \ControlFlowTok{if}\NormalTok{ (row }\OperatorTok{>}\StringTok{ }\DecValTok{8} \OperatorTok{&&}\StringTok{  }\NormalTok{(MPF.BCT.stock.return[row] }\OperatorTok{<}\StringTok{ }\DecValTok{0} \OperatorTok{&&}
\StringTok{                   }\NormalTok{MPF.BCT.stock.return[row }\OperatorTok{-}\StringTok{ }\DecValTok{1}\NormalTok{] }\OperatorTok{>}
\StringTok{                   }\KeywordTok{quantile}\NormalTok{(}\KeywordTok{na.omit}\NormalTok{(MPF.BCT.stock.return), }\KeywordTok{c}\NormalTok{(.}\DecValTok{75}\NormalTok{)))) \{}
\NormalTok{    hedge <-}\StringTok{ }\OtherTok{TRUE}
\NormalTok{  \}}
  
\NormalTok{  MPF.BCT.w.sum <-}\StringTok{ }\KeywordTok{sum}\NormalTok{(MPF.BCT.w[row,])}
  
  
  \ControlFlowTok{if}\NormalTok{ (row }\OperatorTok{<=}\StringTok{ }\DecValTok{12} \OperatorTok{||}\StringTok{ }\NormalTok{MPF.BCT.w.sum }\OperatorTok{==}\StringTok{ }\NormalTok{MPF.BCT.w[row, }\DecValTok{16}\NormalTok{] }\OperatorTok{||}
\StringTok{      }\NormalTok{MPF.BCT.w.sum }\OperatorTok{<}\StringTok{ }\FloatTok{1e-6} \OperatorTok{||}\StringTok{ }\NormalTok{hedge }\OperatorTok{==}\StringTok{ }\OtherTok{TRUE}\NormalTok{) \{}
    \ControlFlowTok{if}\NormalTok{ (row }\OperatorTok{>=}\StringTok{ }\DecValTok{24}\NormalTok{) \{}
\NormalTok{      MPF.BCT.p[row, }\DecValTok{11}\NormalTok{] <-}\StringTok{ }\FloatTok{0.3}
\NormalTok{      MPF.BCT.p[row, }\DecValTok{16}\NormalTok{] <-}\StringTok{ }\FloatTok{0.7}
\NormalTok{    \} }\ControlFlowTok{else}\NormalTok{ \{}
\NormalTok{      MPF.BCT.p[row, }\DecValTok{16}\NormalTok{] <-}\StringTok{ }\DecValTok{1}
\NormalTok{    \}}
\NormalTok{  \} }\ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{ (}\KeywordTok{length}\NormalTok{(}\KeywordTok{which}\NormalTok{(MPF.BCT.w[row,] }\OperatorTok{!=}\StringTok{ }\DecValTok{0}\NormalTok{)) }\OperatorTok{==}\StringTok{ }\DecValTok{1} \OperatorTok{||}
\StringTok{             }\KeywordTok{min}\NormalTok{(MPF.BCT.stock.return[(row }\OperatorTok{-}\StringTok{ }\DecValTok{3}\NormalTok{)}\OperatorTok{:}\NormalTok{row]) }\OperatorTok{<}\StringTok{ }\FloatTok{-0.07}\NormalTok{) \{}
    \ControlFlowTok{if}\NormalTok{ (row }\OperatorTok{>=}\StringTok{ }\DecValTok{24}\NormalTok{) \{}
\NormalTok{      MPF.BCT.p[row,] <-}\StringTok{ }\NormalTok{MPF.BCT.w[row,] }\OperatorTok{/}\StringTok{ }\NormalTok{MPF.BCT.w.sum }\OperatorTok{/}\StringTok{ }\DecValTok{3}
\NormalTok{      MPF.BCT.p[row, }\DecValTok{11}\NormalTok{] <-}\StringTok{ }\NormalTok{MPF.BCT.p[row, }\DecValTok{11}\NormalTok{] }\OperatorTok{+}\StringTok{ }\FloatTok{0.33}
\NormalTok{      MPF.BCT.p[row, }\DecValTok{16}\NormalTok{] <-}\StringTok{ }\NormalTok{MPF.BCT.p[row, }\DecValTok{16}\NormalTok{] }\OperatorTok{+}\StringTok{ }\FloatTok{0.34}
\NormalTok{    \} }\ControlFlowTok{else}\NormalTok{ \{}
\NormalTok{      MPF.BCT.p[row,] <-}\StringTok{ }\NormalTok{MPF.BCT.w[row,] }\OperatorTok{/}\StringTok{ }\NormalTok{MPF.BCT.w.sum }\OperatorTok{/}\StringTok{ }\DecValTok{3}
\NormalTok{      MPF.BCT.p[row, }\DecValTok{16}\NormalTok{] <-}\StringTok{ }\NormalTok{MPF.BCT.p[row, }\DecValTok{16}\NormalTok{] }\OperatorTok{+}\StringTok{ }\FloatTok{0.67}
\NormalTok{    \}}
\NormalTok{  \} }\ControlFlowTok{else}\NormalTok{ \{}
\NormalTok{    MPF.BCT.p[row,] <-}\StringTok{ }\NormalTok{MPF.BCT.w[row,] }\OperatorTok{/}\StringTok{ }\NormalTok{MPF.BCT.w.sum}
\NormalTok{  \}}
  
\NormalTok{  MPF.portf.weight[row,] <-}\StringTok{ }\KeywordTok{round_percent}\NormalTok{(MPF.BCT.p[row,])}
\NormalTok{  portf.rebal.fm <-}
\StringTok{    }\KeywordTok{Return.portfolio}\NormalTok{(}
\NormalTok{      MPF.BCT.returns,}
      \DataTypeTok{weight =}\NormalTok{ MPF.portf.weight,}
      \DataTypeTok{geometric =} \OtherTok{TRUE}\NormalTok{,}
      \DataTypeTok{rebalance_on =} \StringTok{"months"}
\NormalTok{    )}
\NormalTok{  MPF.portf.return[row] <-}
\StringTok{    }\KeywordTok{tail}\NormalTok{(}\KeywordTok{na.omit}\NormalTok{(portf.rebal.fm), }\DecValTok{1}\NormalTok{)}
\NormalTok{  MPF.portf.drawdown <-}\StringTok{ }\KeywordTok{Drawdowns}\NormalTok{(MPF.portf.return,}
                                  \DataTypeTok{geometric =} \OtherTok{TRUE}\NormalTok{)}
  \ControlFlowTok{if}\NormalTok{ (}\KeywordTok{tail}\NormalTok{(}\KeywordTok{na.omit}\NormalTok{(MPF.portf.drawdown), }\DecValTok{1}\NormalTok{) }\OperatorTok{<}\StringTok{ }\FloatTok{-0.065} \OperatorTok{&&}
\StringTok{      }\NormalTok{up }\OperatorTok{==}\StringTok{ }\OtherTok{FALSE}\NormalTok{) \{}
\NormalTok{    hedge =}\StringTok{ }\OtherTok{TRUE}
\NormalTok{  \}}
\NormalTok{\}}

\ControlFlowTok{for}\NormalTok{ (pass }\ControlFlowTok{in} \DecValTok{1}\OperatorTok{:}\DecValTok{30}\NormalTok{) \{}
\NormalTok{  MPF.BCT.w.i <-}\StringTok{ }\NormalTok{MPF.BCT.w}
\NormalTok{  MPF.BCT.w.i[,] <-}\StringTok{ }\NormalTok{MPF.BCT.w.all[, , pass]}
\NormalTok{  MPF.BCT.w.i[MPF.BCT.w.i }\OperatorTok{==}\StringTok{ }\DecValTok{0}\NormalTok{] <-}\StringTok{ }\OtherTok{NA}
  \ControlFlowTok{for}\NormalTok{ (col }\ControlFlowTok{in} \DecValTok{1}\OperatorTok{:}\KeywordTok{length}\NormalTok{(MPF.BCT.w[}\DecValTok{1}\NormalTok{, ])) \{}
\NormalTok{    MPF.BCT.w.i[, col] <-}
\StringTok{      }\NormalTok{((MPF.BCT.w.i[, col] }\OperatorTok{+}\StringTok{ }\DecValTok{1}\NormalTok{) }\OperatorTok{/}\StringTok{ }\DecValTok{2} \OperatorTok{*}\StringTok{ }\NormalTok{(max_return[col] }\OperatorTok{-}\StringTok{ }\NormalTok{min_return[col]) }\OperatorTok{+}\StringTok{ }\NormalTok{min_return[col])}
\NormalTok{  \}}
\NormalTok{  MPF.BCT.returns.mat <-}\StringTok{ }\KeywordTok{as.matrix}\NormalTok{(MPF.BCT.w.all[, , pass])}
  
  \ControlFlowTok{for}\NormalTok{ (row }\ControlFlowTok{in} \DecValTok{1}\OperatorTok{:}\KeywordTok{length}\NormalTok{(MPF.BCT.w.i[, }\DecValTok{1}\NormalTok{])) \{}
\NormalTok{    MPF.BCT.stock.mean <-}\StringTok{ }\DecValTok{0}
\NormalTok{    i <-}\StringTok{ }\DecValTok{0}
    
    \ControlFlowTok{for}\NormalTok{ (col }\ControlFlowTok{in} \DecValTok{1}\OperatorTok{:}\KeywordTok{length}\NormalTok{(MPF.BCT.w.i[}\DecValTok{1}\NormalTok{,])) \{}
\NormalTok{      MPF.BCT.w.i[row, col] <-}
\StringTok{        }\KeywordTok{na.fill}\NormalTok{((MPF.BCT.w.i[row, col]) }\OperatorTok{*}\StringTok{ }\NormalTok{MPF.BCT.RSI.p[row, col], }\DecValTok{0}\NormalTok{)}
      
      \ControlFlowTok{if}\NormalTok{ (col }\OperatorTok{!=}\StringTok{ }\DecValTok{2} \OperatorTok{&&}
\StringTok{          }\NormalTok{col }\OperatorTok{!=}\StringTok{ }\DecValTok{6} \OperatorTok{&&}
\StringTok{          }\NormalTok{col }\OperatorTok{!=}\StringTok{ }\DecValTok{7} \OperatorTok{&&}
\StringTok{          }\NormalTok{col }\OperatorTok{!=}\StringTok{ }\DecValTok{11} \OperatorTok{&&}\StringTok{ }\NormalTok{col }\OperatorTok{!=}\StringTok{ }\DecValTok{14} \OperatorTok{&&}\StringTok{ }\NormalTok{col }\OperatorTok{!=}\StringTok{ }\DecValTok{16} \OperatorTok{&&}\StringTok{ }\NormalTok{col }\OperatorTok{!=}\StringTok{ }\DecValTok{17} \OperatorTok{&&}\StringTok{ }\NormalTok{col }\OperatorTok{!=}\StringTok{ }\DecValTok{18}\NormalTok{) \{}
        \ControlFlowTok{if}\NormalTok{ (}\OperatorTok{!}\KeywordTok{is.na}\NormalTok{(MPF.BCT.returns.mat[row, col]) }\OperatorTok{&&}
\StringTok{            }\NormalTok{MPF.BCT.returns.mat[row, col] }\OperatorTok{!=}\StringTok{ }\DecValTok{0}\NormalTok{) \{}
\NormalTok{          MPF.BCT.stock.mean <-}
\StringTok{            }\NormalTok{MPF.BCT.stock.mean }\OperatorTok{+}\StringTok{ }\NormalTok{MPF.BCT.returns.mat[row, col]}
\NormalTok{          i <-}\StringTok{ }\NormalTok{i }\OperatorTok{+}\StringTok{ }\DecValTok{1}
\NormalTok{        \}}
        
        \ControlFlowTok{if}\NormalTok{ (MPF.BCT.w.i[row, col] }\OperatorTok{<}\StringTok{ }\FloatTok{1e-6}\NormalTok{) \{}
\NormalTok{          MPF.BCT.w.i[row, col] <-}\StringTok{ }\DecValTok{0}
\NormalTok{        \}}
\NormalTok{      \} }\ControlFlowTok{else}\NormalTok{ \{}
        \ControlFlowTok{if}\NormalTok{ (MPF.BCT.w.i[row, col] }\OperatorTok{<}\StringTok{ }\DecValTok{0}\NormalTok{) \{}
\NormalTok{          MPF.BCT.w.i[row, col] <-}\StringTok{ }\DecValTok{0}
\NormalTok{        \}}
\NormalTok{      \}}
\NormalTok{    \}}
    
\NormalTok{    MPF.BCT.stock.return[row] <-}\StringTok{ }\NormalTok{MPF.BCT.stock.mean }\OperatorTok{/}\StringTok{ }\NormalTok{i}
    
    \CommentTok{# Retain two most increasing fund}
\NormalTok{    last <-}\StringTok{ }\KeywordTok{length}\NormalTok{(MPF.BCT.w.i[}\DecValTok{1}\NormalTok{,]) }\OperatorTok{-}\StringTok{ }\NormalTok{top}
\NormalTok{    order <-}\StringTok{ }\KeywordTok{order}\NormalTok{(MPF.BCT.w.i[row,])}
    \ControlFlowTok{for}\NormalTok{ (col }\ControlFlowTok{in}\NormalTok{ order[}\DecValTok{1}\OperatorTok{:}\NormalTok{last]) \{}
\NormalTok{      MPF.BCT.w.i[row, col] <-}\StringTok{ }\DecValTok{0}
\NormalTok{    \}}
    
    \CommentTok{#print("segment 1")}
    
    \ControlFlowTok{if}\NormalTok{ (row }\OperatorTok{>}\StringTok{ }\DecValTok{8} \OperatorTok{&&}
\StringTok{        }\NormalTok{MPF.BCT.stock.return[row] }\OperatorTok{>}
\StringTok{        }\KeywordTok{quantile}\NormalTok{(}\KeywordTok{na.omit}\NormalTok{(MPF.BCT.stock.return), }\KeywordTok{c}\NormalTok{(.}\DecValTok{35}\NormalTok{))  }\OperatorTok{&&}
\StringTok{        }\NormalTok{MPF.BCT.stock.return[row }\OperatorTok{-}\StringTok{ }\DecValTok{3}\NormalTok{] }\OperatorTok{>}
\StringTok{        }\KeywordTok{quantile}\NormalTok{(}\KeywordTok{na.omit}\NormalTok{(MPF.BCT.stock.return), }\KeywordTok{c}\NormalTok{(.}\DecValTok{45}\NormalTok{))) \{}
\NormalTok{      up <-}\StringTok{ }\OtherTok{FALSE}
\NormalTok{    \}}
    
    \ControlFlowTok{if}\NormalTok{ (row }\OperatorTok{>}\StringTok{ }\DecValTok{8} \OperatorTok{&&}\StringTok{ }\NormalTok{hedge }\OperatorTok{&&}
\StringTok{        }\NormalTok{MPF.BCT.stock.return[row] }\OperatorTok{>}
\StringTok{        }\KeywordTok{quantile}\NormalTok{(}\KeywordTok{na.omit}\NormalTok{(MPF.BCT.stock.return), }\KeywordTok{c}\NormalTok{(.}\DecValTok{45}\NormalTok{))  }\OperatorTok{&&}
\StringTok{        }\NormalTok{MPF.BCT.stock.return[row }\OperatorTok{-}\StringTok{ }\DecValTok{3}\NormalTok{] }\OperatorTok{>}
\StringTok{        }\KeywordTok{quantile}\NormalTok{(}\KeywordTok{na.omit}\NormalTok{(MPF.BCT.stock.return), }\KeywordTok{c}\NormalTok{(.}\DecValTok{35}\NormalTok{))) \{}
\NormalTok{      hedge <-}\StringTok{ }\OtherTok{FALSE}
\NormalTok{      up <-}\StringTok{ }\OtherTok{TRUE}
\NormalTok{    \}}
    
    \ControlFlowTok{if}\NormalTok{ (row }\OperatorTok{>}\StringTok{ }\DecValTok{8} \OperatorTok{&&}\StringTok{  }\NormalTok{(MPF.BCT.stock.return[row] }\OperatorTok{<}\StringTok{ }\DecValTok{0} \OperatorTok{&&}
\StringTok{                     }\NormalTok{MPF.BCT.stock.return[row }\OperatorTok{-}\StringTok{ }\DecValTok{1}\NormalTok{] }\OperatorTok{>}
\StringTok{                     }\KeywordTok{quantile}\NormalTok{(}\KeywordTok{na.omit}\NormalTok{(MPF.BCT.stock.return), }\KeywordTok{c}\NormalTok{(.}\DecValTok{75}\NormalTok{)))) \{}
\NormalTok{      hedge <-}\StringTok{ }\OtherTok{TRUE}
\NormalTok{    \}}
    
\NormalTok{    MPF.BCT.w.sum <-}\StringTok{ }\KeywordTok{sum}\NormalTok{(MPF.BCT.w.i[row,])}
\NormalTok{    MPF.BCT.p[row, ] <-}\StringTok{ }\DecValTok{0}
    
    \ControlFlowTok{if}\NormalTok{ (row }\OperatorTok{<=}\StringTok{ }\DecValTok{12} \OperatorTok{||}\StringTok{ }\NormalTok{MPF.BCT.w.sum }\OperatorTok{==}\StringTok{ }\NormalTok{MPF.BCT.w.i[row, }\DecValTok{16}\NormalTok{] }\OperatorTok{||}
\StringTok{        }\NormalTok{MPF.BCT.w.sum }\OperatorTok{<}\StringTok{ }\FloatTok{1e-6} \OperatorTok{||}\StringTok{ }\NormalTok{hedge }\OperatorTok{==}\StringTok{ }\OtherTok{TRUE}\NormalTok{) \{}
      \ControlFlowTok{if}\NormalTok{ (row }\OperatorTok{>=}\StringTok{ }\DecValTok{24}\NormalTok{) \{}
\NormalTok{        MPF.BCT.p[row, }\DecValTok{11}\NormalTok{] <-}\StringTok{ }\FloatTok{0.3}
\NormalTok{        MPF.BCT.p[row, }\DecValTok{16}\NormalTok{] <-}\StringTok{ }\FloatTok{0.7}
\NormalTok{      \} }\ControlFlowTok{else}\NormalTok{ \{}
\NormalTok{        MPF.BCT.p[row, }\DecValTok{16}\NormalTok{] <-}\StringTok{ }\DecValTok{1}
\NormalTok{      \}}
\NormalTok{    \} }\ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{ (}\KeywordTok{length}\NormalTok{(}\KeywordTok{which}\NormalTok{(MPF.BCT.w.i[row,] }\OperatorTok{!=}\StringTok{ }\DecValTok{0}\NormalTok{)) }\OperatorTok{==}\StringTok{ }\DecValTok{1} \OperatorTok{||}
\StringTok{               }\KeywordTok{min}\NormalTok{(MPF.BCT.stock.return[(row }\OperatorTok{-}\StringTok{ }\DecValTok{3}\NormalTok{)}\OperatorTok{:}\NormalTok{row]) }\OperatorTok{<}\StringTok{ }\FloatTok{-0.07}\NormalTok{) \{}
      \ControlFlowTok{if}\NormalTok{ (row }\OperatorTok{>=}\StringTok{ }\DecValTok{24}\NormalTok{) \{}
\NormalTok{        MPF.BCT.p[row,] <-}\StringTok{ }\NormalTok{MPF.BCT.w.i[row,] }\OperatorTok{/}\StringTok{ }\NormalTok{MPF.BCT.w.sum }\OperatorTok{/}\StringTok{ }\DecValTok{3}
\NormalTok{        MPF.BCT.p[row, }\DecValTok{11}\NormalTok{] <-}\StringTok{ }\NormalTok{MPF.BCT.p[row, }\DecValTok{11}\NormalTok{] }\OperatorTok{+}\StringTok{ }\FloatTok{0.33}
\NormalTok{        MPF.BCT.p[row, }\DecValTok{16}\NormalTok{] <-}\StringTok{ }\NormalTok{MPF.BCT.p[row, }\DecValTok{16}\NormalTok{] }\OperatorTok{+}\StringTok{ }\FloatTok{0.34}
\NormalTok{      \} }\ControlFlowTok{else}\NormalTok{ \{}
\NormalTok{        MPF.BCT.p[row,] <-}\StringTok{ }\NormalTok{MPF.BCT.w.i[row,] }\OperatorTok{/}\StringTok{ }\NormalTok{MPF.BCT.w.sum }\OperatorTok{/}\StringTok{ }\DecValTok{3}
\NormalTok{        MPF.BCT.p[row, }\DecValTok{16}\NormalTok{] <-}\StringTok{ }\NormalTok{MPF.BCT.p[row, }\DecValTok{16}\NormalTok{] }\OperatorTok{+}\StringTok{ }\FloatTok{0.67}
\NormalTok{      \}}
\NormalTok{    \} }\ControlFlowTok{else}\NormalTok{ \{}
\NormalTok{      MPF.BCT.p[row,] <-}\StringTok{ }\NormalTok{MPF.BCT.w[row,] }\OperatorTok{/}\StringTok{ }\NormalTok{MPF.BCT.w.sum}
\NormalTok{    \}}
    
\NormalTok{    MPF.portf.weight.all[row, ] <-}
\StringTok{      }\KeywordTok{round_percent}\NormalTok{(MPF.BCT.p[row,])}
    
\NormalTok{    portf.rebal.i <-}
\StringTok{      }\KeywordTok{Return.portfolio}\NormalTok{(}
\NormalTok{        MPF.BCT.returns,}
        \DataTypeTok{weight =}\NormalTok{ MPF.portf.weight.all,}
        \DataTypeTok{geometric =} \OtherTok{TRUE}\NormalTok{,}
        \DataTypeTok{rebalance_on =} \StringTok{"months"}
\NormalTok{      )}
    
\NormalTok{    MPF.portf.return[row] <-}\StringTok{ }\KeywordTok{tail}\NormalTok{(}\KeywordTok{na.omit}\NormalTok{(portf.rebal.fm), }\DecValTok{1}\NormalTok{)}
\NormalTok{    MPF.portf.drawdown <-}\StringTok{ }\KeywordTok{Drawdowns}\NormalTok{(MPF.portf.return,}
                                    \DataTypeTok{geometric =} \OtherTok{TRUE}\NormalTok{)}
    \ControlFlowTok{if}\NormalTok{ (row }\OperatorTok{>}\StringTok{ }\DecValTok{12} \OperatorTok{&&}\StringTok{ }\KeywordTok{tail}\NormalTok{(}\KeywordTok{na.omit}\NormalTok{(MPF.portf.drawdown), }\DecValTok{1}\NormalTok{) }\OperatorTok{<}\StringTok{ }\FloatTok{-0.065} \OperatorTok{&&}
\StringTok{        }\NormalTok{up }\OperatorTok{==}\StringTok{ }\OtherTok{FALSE}\NormalTok{) \{}
\NormalTok{      hedge =}\StringTok{ }\OtherTok{TRUE}
\NormalTok{    \}}
\NormalTok{  \}}
  
  
  
\NormalTok{  SR.all[pass] <-}
\StringTok{    }\KeywordTok{Return.annualized}\NormalTok{(portf.rebal.i, }\DataTypeTok{geometric =} \OtherTok{TRUE}\NormalTok{) }\OperatorTok{/}\StringTok{ }\NormalTok{(}\KeywordTok{StdDev}\NormalTok{(portf.rebal.i) }\OperatorTok{*}\StringTok{ }\KeywordTok{sqrt}\NormalTok{(}\DecValTok{12}\NormalTok{))}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\hypertarget{performance-analysis}{%
\subsubsection{Performance Analysis}\label{performance-analysis}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{portf.rebal.fm <-}\StringTok{ }\KeywordTok{Return.portfolio}\NormalTok{(}
\NormalTok{  MPF.BCT.returns,}
  \DataTypeTok{weight =}\NormalTok{ MPF.portf.weight,}
  \DataTypeTok{geometric =} \OtherTok{TRUE}\NormalTok{,}
  \DataTypeTok{rebalance_on =} \StringTok{"months"}
\NormalTok{)}
\NormalTok{mean.annual.return <-}
\StringTok{  }\KeywordTok{mean}\NormalTok{(}\KeywordTok{do.call}\NormalTok{(rbind, }\KeywordTok{lapply}\NormalTok{(}\KeywordTok{split}\NormalTok{(portf.rebal.fm, }\StringTok{"years"}\NormalTok{), }\ControlFlowTok{function}\NormalTok{(x)}
    \KeywordTok{colMeans}\NormalTok{(x))) }\OperatorTok{*}\StringTok{ }\DecValTok{12}\NormalTok{)}
\KeywordTok{charts.PerformanceSummary}\NormalTok{(}
\NormalTok{  portf.rebal.fm,}
  \DataTypeTok{methods =} \StringTok{"ModifiedES"}\NormalTok{,}
  \DataTypeTok{geometric =} \OtherTok{TRUE}\NormalTok{,}
  \DataTypeTok{p =} \FloatTok{.95}\NormalTok{,}
  \DataTypeTok{main =} \StringTok{"BCT MPF Scheme First Contribution Performance"}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\includegraphics{/home/jchan/MPF-ANN/docs/Results/MPF_BCT_LSTM_v8_files/figure-latex/unnamed-chunk-10-1.pdf}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{portf.rebal.fm.sharpe <-}
\StringTok{  }\KeywordTok{Return.annualized}\NormalTok{(portf.rebal.fm, }\DataTypeTok{geometric =} \OtherTok{TRUE}\NormalTok{) }\OperatorTok{/}\StringTok{ }\NormalTok{(}\KeywordTok{StdDev}\NormalTok{(portf.rebal.fm) }\OperatorTok{*}\StringTok{ }\KeywordTok{sqrt}\NormalTok{(}\DecValTok{12}\NormalTok{))}
\NormalTok{portf.rebal.fm.mean.sharpe <-}
\StringTok{  }\NormalTok{mean.annual.return }\OperatorTok{/}\StringTok{ }\NormalTok{(}\KeywordTok{StdDev}\NormalTok{(portf.rebal.fm) }\OperatorTok{*}\StringTok{ }\KeywordTok{sqrt}\NormalTok{(}\DecValTok{12}\NormalTok{))}
\KeywordTok{rownames}\NormalTok{(portf.rebal.fm.sharpe) <-}\StringTok{ "Sharpe Ratio (annualized)"}
\KeywordTok{rownames}\NormalTok{(portf.rebal.fm.mean.sharpe) <-}
\StringTok{  "Sharpe Ratio (mean annual return)"}
\KeywordTok{colnames}\NormalTok{(portf.rebal.fm.mean.sharpe) <-}\StringTok{ "portfolio.returns"}
\KeywordTok{Return.annualized}\NormalTok{(portf.rebal.fm, }\DataTypeTok{geometric =} \OtherTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##                   portfolio.returns
## Annualized Return         0.1188269
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mean.annual.return}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 0.1147017
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{portf.rebal.fm.sharpe}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##                           portfolio.returns
## Sharpe Ratio (annualized)          1.252589
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{portf.rebal.fm.mean.sharpe}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##                                   portfolio.returns
## Sharpe Ratio (mean annual return)          1.209104
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{StdDev.annualized}\NormalTok{(portf.rebal.fm)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##                               portfolio.returns
## Annualized Standard Deviation        0.09486504
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{SortinoRatio}\NormalTok{(portf.rebal.fm)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##                          portfolio.returns
## Sortino Ratio (MAR = 0%)         0.8053901
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{ES}\NormalTok{(portf.rebal.fm, }\DataTypeTok{method =} \StringTok{"historical"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    portfolio.returns
## ES       -0.04456358
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{tail}\NormalTok{(MPF.portf.weight, }\DataTypeTok{n =} \DecValTok{1}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##            MPF.BCT.AE MPF.BCT.CA MPF.BCT.CEHK MPF.BCT.CT MPF.BCT.EU
## 2019-08-30          0          0            0          0          0
##            MPF.BCT.E3 MPF.BCT.E5 MPF.BCT.E7 MPF.BCT.E9 MPF.BCT.FM
## 2019-08-30          0          0          0          0          0
##            MPF.BCT.GB MPF.BCT.GE MPF.BCT.GT MPF.BCT.HKB MPF.BCT.HSIT
## 2019-08-30        0.3          0          0           0            0
##            MPF.BCT.MPFC MPF.BCT.RMBB MPF.BCT.SFP MPF.BCT.SE2040
## 2019-08-30          0.7            0           0              0
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{### Deflated Sharpe Ratio}
\NormalTok{SR_zero <-}
\StringTok{  }\KeywordTok{sqrt}\NormalTok{((}\KeywordTok{StdDev}\NormalTok{(SR.all)) }\OperatorTok{^}\StringTok{ }\DecValTok{2} \OperatorTok{/}\StringTok{ }\DecValTok{12}\NormalTok{) }\OperatorTok{*}\StringTok{ }\NormalTok{((}\DecValTok{1} \OperatorTok{-}\StringTok{ }\FloatTok{0.57721}\NormalTok{) }\OperatorTok{*}\StringTok{ }\KeywordTok{qnorm}\NormalTok{(}\DecValTok{1} \OperatorTok{-}\StringTok{ }\DecValTok{1} \OperatorTok{/}\StringTok{ }\DecValTok{31}\NormalTok{) }\OperatorTok{+}
\StringTok{                                       }\NormalTok{(}\FloatTok{0.57721}\NormalTok{) }\OperatorTok{*}\StringTok{ }\KeywordTok{qnorm}\NormalTok{(}\DecValTok{1} \OperatorTok{-}\StringTok{ }\NormalTok{(}\DecValTok{1} \OperatorTok{/}\StringTok{ }\NormalTok{(}\DecValTok{31} \OperatorTok{*}\StringTok{ }\FloatTok{2.71828}\NormalTok{))))}
\NormalTok{DSR <-}
\StringTok{  }\KeywordTok{pnorm}\NormalTok{(((portf.rebal.fm.sharpe }\OperatorTok{/}\StringTok{ }\KeywordTok{sqrt}\NormalTok{(}\DecValTok{12}\NormalTok{) }\OperatorTok{-}\StringTok{ }\NormalTok{SR_zero) }\OperatorTok{*}\StringTok{ }\KeywordTok{sqrt}\NormalTok{(}\KeywordTok{length}\NormalTok{(MPF.BCT.returns[, }\DecValTok{1}\NormalTok{]))) }\OperatorTok{/}
\StringTok{          }\KeywordTok{sqrt}\NormalTok{(}\DecValTok{1} \OperatorTok{-}\StringTok{ }\KeywordTok{skewness}\NormalTok{(portf.rebal.fm) }\OperatorTok{*}\StringTok{ }\NormalTok{portf.rebal.fm.sharpe }\OperatorTok{+}\StringTok{ }
\StringTok{                 }\NormalTok{((}\KeywordTok{kurtosis}\NormalTok{(portf.rebal.fm) }\OperatorTok{-}\StringTok{ }\DecValTok{1}\NormalTok{) }\OperatorTok{/}\StringTok{ }\DecValTok{4}\NormalTok{) }\OperatorTok{*}\StringTok{ }\NormalTok{(portf.rebal.fm.sharpe) }\OperatorTok{^}\StringTok{ }\DecValTok{2}\NormalTok{)}
\NormalTok{  )}

\KeywordTok{rownames}\NormalTok{(DSR) <-}\StringTok{ "Deflated Sharpe Ratio"}
\NormalTok{DSR}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##                       portfolio.returns
## Deflated Sharpe Ratio                 1
\end{verbatim}

\hypertarget{monthly-installment}{%
\subsubsection{Monthly Installment}\label{monthly-installment}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{MPF.BCT.units <-}\StringTok{ }\NormalTok{MPF.BCT.returns}
\NormalTok{MPF.BCT.units[, ] <-}\StringTok{ }\DecValTok{0}

\NormalTok{MPF.monthly.asset <-}\StringTok{ }\NormalTok{MPF.BCT.returns}
\NormalTok{MPF.monthly.asset[, ] <-}\StringTok{ }\DecValTok{0}

\NormalTok{MPF.monthly.returns <-}
\StringTok{  }\KeywordTok{as.xts}\NormalTok{(}\KeywordTok{rowSums}\NormalTok{(MPF.BCT.returns), }\DataTypeTok{order.by =}\NormalTok{ monthly)}
\NormalTok{MPF.monthly.returns[] <-}\StringTok{ }\DecValTok{0}

\NormalTok{MPF.time <-}\StringTok{ }\DecValTok{0}\OperatorTok{:}\KeywordTok{length}\NormalTok{(MPF.BCT.returns[, }\DecValTok{1}\NormalTok{]) }\OperatorTok{/}\StringTok{ }\DecValTok{12}
\NormalTok{MPF.pay <-}\StringTok{ }\DecValTok{-1500} \OperatorTok{+}\StringTok{ }\DecValTok{0} \OperatorTok{*}\StringTok{ }\NormalTok{MPF.time}

\ControlFlowTok{for}\NormalTok{ (row }\ControlFlowTok{in} \DecValTok{1}\OperatorTok{:}\KeywordTok{length}\NormalTok{(MPF.BCT.returns[, }\DecValTok{1}\NormalTok{])) \{}
\NormalTok{  this.price <-}\StringTok{ }\KeywordTok{as.matrix}\NormalTok{(MPF.BCT[monthly[row]])}
\NormalTok{  MPF.BCT.units[row, ] <-}\StringTok{ }\NormalTok{this.price}
  
  \ControlFlowTok{if}\NormalTok{ (row }\OperatorTok{==}\StringTok{ }\DecValTok{1}\NormalTok{) \{}
\NormalTok{    last.value <-}\StringTok{ }\DecValTok{1500}
\NormalTok{    this.value <-}\StringTok{ }\KeywordTok{as.numeric}\NormalTok{((}\DecValTok{1500} \OperatorTok{/}\StringTok{ }\NormalTok{MPF.BCT[}\DecValTok{1}\NormalTok{, }\DecValTok{16}\NormalTok{]) }\OperatorTok{*}\StringTok{ }\NormalTok{this.price[}\DecValTok{16}\NormalTok{])}
\NormalTok{    MPF.monthly.returns[row] <-}\StringTok{ }\KeywordTok{log}\NormalTok{(this.value }\OperatorTok{/}\StringTok{ }\NormalTok{last.value)}
\NormalTok{    MPF.monthly.asset[row,] <-}
\StringTok{      }\NormalTok{(this.value }\OperatorTok{+}\StringTok{ }\DecValTok{1500}\NormalTok{) }\OperatorTok{/}\StringTok{ }\NormalTok{this.price }\OperatorTok{*}\StringTok{ }\NormalTok{MPF.portf.weight[row, ]}
\NormalTok{    last.price <-}\StringTok{ }\NormalTok{this.price}
\NormalTok{  \} }\ControlFlowTok{else}\NormalTok{ \{}
\NormalTok{    last.value <-}
\StringTok{      }\KeywordTok{as.numeric}\NormalTok{(}\KeywordTok{sum}\NormalTok{(}\KeywordTok{na.fill}\NormalTok{(last.price }\OperatorTok{*}\StringTok{ }\NormalTok{MPF.monthly.asset[row }\OperatorTok{-}\StringTok{ }\DecValTok{1}\NormalTok{, ], }\DecValTok{0}\NormalTok{)))}
\NormalTok{    this.value <-}
\StringTok{      }\KeywordTok{as.numeric}\NormalTok{(}\KeywordTok{sum}\NormalTok{(}\KeywordTok{na.fill}\NormalTok{(this.price }\OperatorTok{*}\StringTok{ }\NormalTok{MPF.monthly.asset[row }\OperatorTok{-}\StringTok{ }\DecValTok{1}\NormalTok{, ], }\DecValTok{0}\NormalTok{)))}
\NormalTok{    MPF.monthly.returns[row] <-}\StringTok{ }\KeywordTok{log}\NormalTok{(this.value }\OperatorTok{/}\StringTok{ }\NormalTok{last.value)}
\NormalTok{    MPF.monthly.asset[row,] <-}
\StringTok{      }\NormalTok{(this.value }\OperatorTok{+}\StringTok{ }\DecValTok{1500}\NormalTok{) }\OperatorTok{/}\StringTok{ }\NormalTok{this.price }\OperatorTok{*}\StringTok{ }\NormalTok{MPF.portf.weight[row, ]}
\NormalTok{    last.price <-}\StringTok{ }\NormalTok{this.price}
\NormalTok{  \}}
\NormalTok{\}}


\NormalTok{total.asset.value <-}\StringTok{ }\KeywordTok{sum}\NormalTok{(MPF.monthly.asset[row, ] }\OperatorTok{*}\StringTok{ }\NormalTok{this.price)}
\NormalTok{total.contribution <-}\StringTok{ }\DecValTok{1500} \OperatorTok{*}\StringTok{ }\KeywordTok{length}\NormalTok{(MPF.BCT.returns[, }\DecValTok{1}\NormalTok{])}

\NormalTok{MPF.pay[row }\OperatorTok{+}\StringTok{ }\DecValTok{1}\NormalTok{] <-}\StringTok{ }\NormalTok{total.asset.value}
\NormalTok{IRR.f <-}\StringTok{ }\ControlFlowTok{function}\NormalTok{(r)}
  \KeywordTok{sum}\NormalTok{(MPF.pay }\OperatorTok{*}\StringTok{ }\KeywordTok{exp}\NormalTok{(}\OperatorTok{-}\NormalTok{r }\OperatorTok{*}\StringTok{ }\NormalTok{MPF.time))}
\NormalTok{IRR.root <-}\StringTok{ }\KeywordTok{uniroot}\NormalTok{(IRR.f, }\KeywordTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{1}\NormalTok{))}


\NormalTok{total.asset.value}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 1048491
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{total.contribution}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 337500
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mean.monthly.annual.return <-}
\StringTok{  }\KeywordTok{mean}\NormalTok{(}\KeywordTok{do.call}\NormalTok{(rbind, }\KeywordTok{lapply}\NormalTok{(}\KeywordTok{split}\NormalTok{(MPF.monthly.returns, }\StringTok{"years"}\NormalTok{), }\ControlFlowTok{function}\NormalTok{(x)}
    \KeywordTok{colMeans}\NormalTok{(x))) }\OperatorTok{*}\StringTok{ }\DecValTok{12}\NormalTok{)}
\NormalTok{mean.monthly.annual.return}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 0.1014057
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{IRR.root}\OperatorTok{$}\NormalTok{root}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 0.1040667
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{stddev.monthly <-}\StringTok{ }\NormalTok{(}\KeywordTok{StdDev}\NormalTok{(MPF.monthly.returns) }\OperatorTok{*}\StringTok{ }\KeywordTok{sqrt}\NormalTok{(}\DecValTok{12}\NormalTok{))}
\NormalTok{monthly.installment.sharpe.ratio <-}
\StringTok{  }\NormalTok{mean.monthly.annual.return }\OperatorTok{/}\StringTok{ }\NormalTok{stddev.monthly}
\KeywordTok{rownames}\NormalTok{(monthly.installment.sharpe.ratio) <-}
\StringTok{  "Sharpe Ratio (mean annual return)"}
\NormalTok{monthly.installment.sharpe.ratio}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##                                       [,1]
## Sharpe Ratio (mean annual return) 1.072172
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{StdDev.annualized}\NormalTok{(MPF.monthly.returns)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##                                     [,1]
## Annualized Standard Deviation 0.09457973
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{ES}\NormalTok{(MPF.monthly.returns, }\DataTypeTok{method =} \StringTok{"historical"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##           [,1]
## ES -0.04532327
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{SortinoRatio}\NormalTok{(MPF.monthly.returns)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##                               [,1]
## Sortino Ratio (MAR = 0%) 0.7323655
\end{verbatim}


\end{document}
